<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f7f9fc; color: #222; }
h1,h2 { margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 6px; }
th, td { padding: 6px 8px; border: 1px solid #e6e9ef; font-size: 13px; }
input[type="text"], input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; }
input[type="color"] { width: 48px; height: 32px; border: none; cursor: pointer; }
button { padding: 6px 10px; border-radius: 6px; border: 1px solid #cfcfcf; background: #f0f0f0; cursor: pointer; }
button.primary { background: #2d6cdf; color: #fff; border-color: #2a63d6; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; align-items: center; }
pre#results { max-height: 300px; overflow: auto; background: #fcfcff; padding: 10px; border-radius: 6px; border: 1px solid #e7e9ef; font-size: 13px; white-space: pre-wrap; }
.chart-container { width: 100%; max-width: 600px; height: 300px; margin-top: 10px; }
#seatCanvas { border:1px solid #ccc; margin-top:10px; border-radius:6px; }
</style>
</head>
<body>

<h1>National Council Seat Allocator</h1>

<h2>Party List Results</h2>
<table id="houseTable">
<thead><tr><th>Party Name</th><th>Votes</th><th>Color</th><th>Action</th></tr></thead>
<tbody id="houseBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#d62728"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#9467bd"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#2ca02c"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ff7f0e"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#1f77b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
<thead><tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="partyListBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="text" value="Josef, John Louis"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="text" value="Cierna"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Dreamersk"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="text" value="Hiro Solarist"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="text" value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party</button>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats: <input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% votes required): <input type="number" id="threshold" value="0" min="0" max="100"></label><br>
<div class="controls">
  <button class="primary" onclick="allocateSeats()">Allocate Seats</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="downloadSeatImage()">Download Seat Grid Image</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Visual Seat Grid</h2>
<canvas id="seatCanvas"></canvas>

<script>
// --- Table helpers ---
function deleteRow(btn){btn.closest('tr').remove();}
function addHouseRow(){
  const tr=document.createElement('tr');
  tr.innerHTML='<td><input type="text"></td><td><input type="number" min="0"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>';
  document.getElementById('houseBody').appendChild(tr);
}
function addPartyListRow(){
  const tr=document.createElement('tr');
  tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>';
  document.getElementById('partyListBody').appendChild(tr);
}

// --- Allocation logic ---
let seatAssignmentsGlobal=[], councilSeatsGlobal={}, partyColorsGlobal={}, councilPartiesGlobal=[], occupiedByPartyGlobal={}, vacantByPartyGlobal={}, nextPartyGlobal='';

function allocateSeats(){
  const houseResults={}, partyColors={}, partyOrder=[], partyLists={};
  let totalVotes=0;
  
  document.querySelectorAll('#houseTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input');
    const party=inputs[0].value.trim();
    const votes=parseInt(inputs[1].value)||0;
    const color=inputs[2].value||'#888888';
    if(party){houseResults[party]=votes; partyColors[party]=color; partyOrder.push(party); totalVotes+=votes;}
  });

  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacantSeats=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||1000;

  document.querySelectorAll('#partyListTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input');
    const party=inputs[0].value.trim();
    if(party){partyLists[party]=inputs[1].value.split(',').map(s=>s.trim()).filter(Boolean);}
  });

  const councilParties=[];
  const councilSeats={}, occupiedByParty={}, vacantByParty={};
  for(const p of partyOrder){
    if(totalVotes>0 && (houseResults[p]/totalVotes*100)<threshold) continue;
    councilParties.push(p); councilSeats[p]=0; occupiedByParty[p]=0; vacantByParty[p]=0;
  }
  if(councilParties.length===0){
    document.getElementById('results').textContent='No parties meet the threshold.';
    drawSeatGrid([],0);
    return;
  }

  function getNextCandidate(p){return partyLists[p]&&partyLists[p].length?partyLists[p].shift():null;}
  const seatAssignments=[]; let assignedSeats=0, vacantSeats=0, occupiedSeats=0;

  while(vacantSeats<requiredVacantSeats && assignedSeats<maxSeats){
    let maxQ=-1, nextParty=councilParties[0];
    for(const p of councilParties){
      const q=(houseResults[p]||0)/(councilSeats[p]+1);
      if(q>maxQ){maxQ=q; nextParty=p;}
    }
    const candidate=getNextCandidate(nextParty);
    assignedSeats++; councilSeats[nextParty]++;
    if(candidate){seatAssignments.push([assignedSeats,nextParty,candidate]); occupiedSeats++; occupiedByParty[nextParty]++;}
    else{seatAssignments.push([assignedSeats,nextParty,'VACANT']); vacantSeats++; vacantByParty[nextParty]++;}
  }

  // Next party in line
  let nextInLine='N/A';
  if(assignedSeats<maxSeats){
    let maxQ=-1;
    for(const p of councilParties){
      const q=(houseResults[p]||0)/(councilSeats[p]+1);
      if(q>maxQ){maxQ=q; nextInLine=p;}
    }
  }
  nextPartyGlobal=nextInLine;

  // Save for seat grid
  seatAssignmentsGlobal=seatAssignments;
  councilSeatsGlobal=councilSeats;
  partyColorsGlobal=partyColors;
  councilPartiesGlobal=councilParties;
  occupiedByPartyGlobal=occupiedByParty;
  vacantByPartyGlobal=vacantByParty;

  // --- Display text results ---
  let output='National Council Seat Assignments:\n';
  seatAssignments.forEach(([num,party,member])=>output+=`Seat ${num}: ${party} â†’ ${member}\n`);
  output+='\nSeat Totals (including vacant seats):\n'; councilParties.forEach(p=>output+=`${p}: ${councilSeats[p]}\n`);
  output+='\nOccupied Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${occupiedByParty[p]}\n`);
  output+='\nVacant Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${vacantByParty[p]}\n`);
  output+=`\nTotal Seats Assigned: ${assignedSeats}\nðŸ“Œ Next Party in Line: ${nextInLine}`;
  document.getElementById('results').textContent=output;

  // Draw the seat grid
  drawSeatGrid(seatAssignments, assignedSeats);
}

// --- Seat Grid Renderer ---
function drawSeatGrid(seats,totalSeats){
  const canvas=document.getElementById('seatCanvas');
  const ctx=canvas.getContext('2d');

  const seatSize=60; // width/height
  const padding=10;
  const seatsPerRow=Math.min(10,totalSeats);
  const rows=Math.ceil(totalSeats/seatsPerRow);
  canvas.width=seatsPerRow*(seatSize+padding)+padding;
  canvas.height=rows*(seatSize+padding)+150; // extra for legend

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.font='12px Arial';
  ctx.textAlign='center';
  ctx.textBaseline='middle';

  // Draw seats
  seats.forEach((seat,i)=>{
    const row=Math.floor(i/seatsPerRow);
    const col=i%seatsPerRow;
    const x=padding+col*(seatSize+padding);
    const y=padding+row*(seatSize+padding);
    const color=seat[2]==='VACANT'?'#d3d3d3':partyColorsGlobal[seat[1]]||'#888888';
    ctx.fillStyle=color;
    ctx.fillRect(x,y,seatSize,seatSize);
    ctx.strokeStyle='#333';
    ctx.strokeRect(x,y,seatSize,seatSize);

    const text1='#'+seat[0];
    const text2=seat[2]==='VACANT'?'VACANT':seat[2];
    ctx.fillStyle='#000';
    ctx.fillText(text1,x+seatSize/2,y+seatSize/3);
    ctx.fillText(text2,x+seatSize/2,y+seatSize*2/3);
  });

  // Draw legend
  let legendY=rows*(seatSize+padding)+20;
  let legendX=padding;
  councilPartiesGlobal.forEach(p=>{
    ctx.fillStyle=partyColorsGlobal[p]||'#888';
    ctx.fillRect(legendX,legendY,20,20);
    ctx.fillStyle='#000';
    ctx.textAlign='left';
    ctx.fillText(`${p}: ${occupiedByPartyGlobal[p]} occupied / ${vacantByPartyGlobal[p]} vacant`,legendX+25,legendY+10);
    legendY+=25;
  });

  // Next party
  ctx.fillStyle='#000';
  ctx.textAlign='left';
  ctx.fillText(`ðŸ“Œ Next Party in Line: ${nextPartyGlobal}`,padding,legendY+15);
}

// --- Download seat image ---
function downloadSeatImage(){
  const canvas=document.getElementById('seatCanvas');
  const link=document.createElement('a');
  link.href=canvas.toDataURL('image/png');
  link.download='national_council_seats.png';
  link.click();
}

// --- CSV export ---
function exportCSV(){
  const text=document.getElementById('results').textContent.replace(/\n/g,'\r\n');
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='allocation_results.txt'; a.click();
}
</script>
</body>
</html>
