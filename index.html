<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>National Council Seat Allocator</title>
<style>
  body{font-family:Arial,sans-serif;margin:20px;background:#f7f9fc;color:#222;}
  h1,h2{margin:0 0 8px;}
  table{width:100%;border-collapse:collapse;margin-top:6px;}
  th, td{padding:6px 8px;border:1px solid #e6e9ef;font-size:13px;}
  input[type="number"], input[type="text"]{padding:6px;width:100%;box-sizing:border-box;}
  input[type="color"]{height:32px;width:48px;border:0;background:transparent;cursor:pointer;}
  button{padding:8px 10px;border-radius:6px;border:1px solid #cfcfcf;background:#f0f0f0;cursor:pointer;}
  button.primary{background:#2d6cdf;color:#fff;border-color:#2a63d6;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center}
  pre#results{max-height:300px;overflow:auto;background:#fcfcff;padding:10px;border-radius:6px;border:1px solid #e7e9ef;white-space:pre-wrap;font-size:13px;}
  canvas{width:100%;max-width:720px;background:#fff;border-radius:6px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>National Council Seat Allocator</h1>

<h2>Party List Results</h2>
<table id="houseTable">
<thead><tr><th>Party Name</th><th>Votes</th><th>Color</th><th>Action</th></tr></thead>
<tbody id="houseBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#d62728"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#9467bd"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#2ca02c"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ff7f0e"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#1f77b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
<thead><tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="partyListBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="text" value="Josef, John Louis"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="text" value="Cierna"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Dreamersk"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="text" value="Hiro Solarist"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="text" value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party</button>

<h2>Settings</h2>
<label>Required Vacant Seats:<input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats:<input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% votes required):<input type="number" id="threshold" value="0" min="0" max="100"></label><br>
<div class="controls">
<button class="primary" onclick="allocateSeats()">Allocate Seats</button>
<button onclick="exportCSV()">Export CSV</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Visualizations</h2>
<canvas id="vacantChart" aria-label="Vacant vs Occupied per party"></canvas>

<script>
let vacantChart=null;
function deleteRow(btn){btn.closest('tr').remove();}
function addHouseRow(){const tr=document.createElement('tr');tr.innerHTML='<td><input type="text"></td><td><input type="number" min="0"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>';document.getElementById('houseBody').appendChild(tr);}
function addPartyListRow(){const tr=document.createElement('tr');tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>';document.getElementById('partyListBody').appendChild(tr);}

function allocateSeats(){
  const houseResults={}; const partyColors={}; const partyOrder=[]; let totalVotes=0;
  document.querySelectorAll('#houseTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input');
    const party=inputs[0].value.trim(); const votes=parseInt(inputs[1].value)||0; const color=inputs[2].value||'#888888';
    if(party){houseResults[party]=votes;partyColors[party]=color;partyOrder.push(party);totalVotes+=votes;}
  });
  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacantSeats=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||1000;

  const partyLists={};
  document.querySelectorAll('#partyListTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input');
    const party=inputs[0].value.trim();
    if(party){partyLists[party]=inputs[1].value.split(',').map(s=>s.trim()).filter(Boolean);}
  });

  const councilParties=[]; const councilSeats={}; const occupiedByParty={}; const vacantByParty={};
  for(const party of partyOrder){if(totalVotes>0&&(houseResults[party]/totalVotes*100)<threshold)continue;councilParties.push(party);councilSeats[party]=0;occupiedByParty[party]=0;vacantByParty[party]=0;}
  if(councilParties.length===0){document.getElementById('results').textContent='No parties meet threshold.';if(vacantChart){vacantChart.destroy();vacantChart=null;}return;}

  function getNextCandidate(p){return partyLists[p]&&partyLists[p].length?partyLists[p].shift():null;}
  let seatAssignments=[]; let assignedSeats=0, vacantSeats=0, occupiedSeats=0;
  while(vacantSeats<requiredVacantSeats && assignedSeats<maxSeats){
    let maxQ=-1, nextParty=councilParties[0];
    for(const p of councilParties){const q=(houseResults[p]||0)/(councilSeats[p]+1);if(q>maxQ){maxQ=q;nextParty=p;}}
    const candidate=getNextCandidate(nextParty);assignedSeats++;councilSeats[nextParty]++;
    if(candidate){seatAssignments.push([assignedSeats,nextParty,candidate]);occupiedSeats++;occupiedByParty[nextParty]++;}
    else{seatAssignments.push([assignedSeats,nextParty,'VACANT']);vacantSeats++;vacantByParty[nextParty]++;}
  }

  let nextInLineParty='N/A'; if(assignedSeats<maxSeats){let maxQ=-1;for(const p of councilParties){const q=(houseResults[p]||0)/(councilSeats[p]+1);if(q>maxQ){maxQ=q;nextInLineParty=p;}}}

  let output='National Council Seat Assignments:\\n';
  seatAssignments.forEach(([num,party,member])=>output+=`Seat ${num}: ${party} â†’ ${member}\\n`);
  output+='\\nSeat Totals (including vacant seats):\\n';councilParties.forEach(p=>output+=`${p}: ${councilSeats[p]}\\n`);
  output+='\\nOccupied Seats by Party:\\n';councilParties.forEach(p=>output+=`${p}: ${occupiedByParty[p]}\\n`);
  output+='\\nVacant Seats by Party:\\n';councilParties.forEach(p=>output+=`${p}: ${vacantByParty[p]}\\n`);
  output+=`\\nTotal Occupied Seats: ${occupiedSeats}\\nTotal Vacant Seats: ${vacantSeats}\\nTotal Seats Assigned: ${assignedSeats}\\n\\nðŸ“Œ Next Party in Line: ${nextInLineParty}`;
  document.getElementById('results').textContent=output;

  // Vacant vs Occupied chart
  const ctx=document.getElementById('vacantChart').getContext('2d');
  const labels=councilParties;
  const occupiedData=labels.map(p=>occupiedByParty[p]||0);
  const vacantData=labels.map(p=>vacantByParty[p]||0);
  const occupiedColors=labels.map(p=>partyColors[p]||'#4caf50'); const vacantColors=labels.map(()=>'#d3d3d3');
  if(vacantChart){vacantChart.destroy();vacantChart=null;}
  vacantChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Occupied',data:occupiedData,backgroundColor:occupiedColors,stack:'stack1'},{label:'Vacant',data:vacantData,backgroundColor:vacantColors,stack:'stack1'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}});
}

function exportCSV(){
  const text=document.getElementById('results').textContent||'';
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='allocation_results.txt';a.click();
}
</script>
</body>
</html>
