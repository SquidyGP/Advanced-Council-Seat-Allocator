<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator with Factions</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e2f; color: #fff; }
h1,h2 { margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 6px; color:#000; background:#fff; }
th, td { padding: 6px 8px; border: 1px solid #ccc; font-size: 13px; }
input[type="text"], input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; }
input[type="color"] { width: 48px; height: 32px; border: none; cursor: pointer; }
button { padding: 6px 10px; border-radius: 6px; border: 1px solid #cfcfcf; background: #f0f0f0; cursor: pointer; }
button.primary { background: #2d6cdf; color: #fff; border-color: #2a63d6; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; align-items: center; }
pre#results { max-height: 300px; overflow: auto; background: #2a2a3a; padding: 10px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; color:#fff; }
canvas { border:1px solid #ccc; margin-top:10px; border-radius:6px; background: transparent; }
</style>
</head>
<body>

<h1>National Council Seat Allocator with Factions</h1>

<h2>Party List Results</h2>
<table id="houseTable">
<thead><tr><th>Party Name</th><th>Votes</th><th>Color</th><th>Action</th></tr></thead>
<tbody id="houseBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
<thead><tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="partyListBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="text" value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="text" value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi- ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="text" value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="text" value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party</button>

<h2>Faction Lists (Optional)</h2>
<table id="factionTable">
<thead><tr><th>Party</th><th>Faction Name</th><th>Votes</th><th>Candidate Names</th><th>Action</th></tr></thead>
<tbody id="factionBody">
</tbody>
</table>
<button onclick="addFactionRow()">+ Add Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats: <input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% votes required): <input type="number" id="threshold" value="5" min="0" max="100"></label><br>

<div class="controls">
  <button class="primary" onclick="allocateSeats()">Allocate Seats</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="downloadSeatImage()">Download Seat Grid Image</button>
  <button onclick="downloadSortedSeatImage()">Download Sorted Seat Grid Image</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Original Seat Grid</h2>
<canvas id="seatCanvas"></canvas>

<h2>Sorted Seat Grid (Largest Party → Smallest, Vacants Last)</h2>
<canvas id="seatCanvasSorted"></canvas>

<script>
// --- Table helpers ---
function deleteRow(btn){btn.closest('tr').remove();}
function addHouseRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="number" min="0"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('houseBody').appendChild(tr);}
function addPartyListRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('partyListBody').appendChild(tr);}
function addFactionRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('factionBody').appendChild(tr);}

// --- Globals ---
let seatAssignmentsGlobal=[], councilSeatsGlobal={}, partyColorsGlobal={}, councilPartiesGlobal=[], occupiedByPartyGlobal={}, vacantByPartyGlobal={}, nextPartyGlobal='';

// --- Allocation ---
function allocateSeats(){
  const houseResults={}, partyColors={}, partyOrder=[]; let totalVotes=0;
  document.querySelectorAll('#houseTable tbody tr').forEach(r=>{const inputs=r.querySelectorAll('input'); const party=inputs[0].value.trim(); const votes=parseInt(inputs[1].value)||0; const color=inputs[2].value||'#888'; if(party){houseResults[party]=votes; partyColors[party]=color; partyOrder.push(party); totalVotes+=votes;}});
  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacantSeats=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||1000;

  // Main party lists
  const partyLists={}; document.querySelectorAll('#partyListTable tbody tr').forEach(r=>{const inputs=r.querySelectorAll('input'); const party=inputs[0].value.trim(); if(party){partyLists[party]=inputs[1].value.split(',').map(s=>s.trim()).filter(Boolean);}});

  // Factions
  const factionVotes={}, factionLists={};
  document.querySelectorAll('#factionTable tbody tr').forEach(r=>{const inputs=r.querySelectorAll('input'); const party=inputs[0].value.trim(); const faction=inputs[1].value.trim(); const votes=parseInt(inputs[2].value)||0; const candidates=inputs[3].value.split(',').map(s=>s.trim()).filter(Boolean); if(party && faction){factionVotes[party]=factionVotes[party]||{}; factionVotes[party][faction]=votes; factionLists[party]=factionLists[party]||{}; factionLists[party][faction]=candidates;}});

  // Parties passing threshold
  const councilParties=[], councilSeats={}, occupiedByParty={}, vacantByParty={};
  for(const p of partyOrder){
    const totalPartyVotes=houseResults[p]+(factionVotes[p]?Object.values(factionVotes[p]).reduce((a,b)=>a+b,0):0);
    if(totalVotes===0 || totalPartyVotes/totalVotes*100>=threshold){councilParties.push(p); councilSeats[p]=0; occupiedByParty[p]=0; vacantByParty[p]=0;}
  }

  // D'Hondt allocation with vacant seats
  const seatAssignments=[]; let assignedSeats=0, vacantSeats=0;
  function getNextCandidate(p){return partyLists[p]&&partyLists[p].length?partyLists[p].shift():'VACANT';}
  while(vacantSeats<requiredVacantSeats && assignedSeats<maxSeats){
    const quotients={}; for(const p of councilParties) quotients[p]=houseResults[p]/(councilSeats[p]+1);
    const nextParty=Object.keys(quotients).reduce((a,b)=>quotients[a]>quotients[b]?a:b);

    councilSeats[nextParty]++; assignedSeats++;
    // Internal seat distribution
    const internalCandidates=[]; const totalInternalVotes=(houseResults[nextParty]||0)+(factionVotes[nextParty]?Object.values(factionVotes[nextParty]).reduce((a,b)=>a+b,0):0);
    if(totalInternalVotes>0){
      const allocation={};
      allocation['Main']=Math.round(councilSeats[nextParty]*(houseResults[nextParty]||0)/totalInternalVotes);
      if(factionVotes[nextParty]) for(const f in factionVotes[nextParty]) allocation[f]=Math.round(councilSeats[nextParty]*factionVotes[nextParty][f]/totalInternalVotes);

      // Flatten allocation into sequence
      for(const key in allocation){
        const seatsToAssign=allocation[key]; let list=(key==='Main')?partyLists[nextParty]:factionLists[nextParty][key]||[]; for(let i=0;i<seatsToAssign;i++){
          const candidate=list.length?list.shift():'VACANT';
          internalCandidates.push([nextParty,candidate,key==='Main'?'':key]);
        }
      }
    }

    // Pick first available internal candidate for this seat
    let chosen=['VACANT']; for(const c of internalCandidates){if(!seatAssignments.some(s=>s[2]===c[1])){chosen=[nextParty,c[1],c[2]]; break;}}
    if(chosen[1]==='VACANT'){vacantSeats++; vacantByParty[nextParty]++;} else{occupiedByParty[nextParty]++;}
    seatAssignments.push([assignedSeats,chosen[0],chosen[1],chosen[2]]);
  }

  // Next in line
  const quotientsNext={}; for(const p of councilParties) quotientsNext[p]=houseResults[p]/(councilSeats[p]+1); nextPartyGlobal=Object.keys(quotientsNext).reduce((a,b)=>quotientsNext[a]>quotientsNext[b]?a:b);

  // Save globals
  seatAssignmentsGlobal=seatAssignments; councilSeatsGlobal=councilSeats; partyColorsGlobal=partyColors;
  councilPartiesGlobal=councilParties; occupiedByPartyGlobal=occupiedByParty; vacantByPartyGlobal=vacantByParty;

  // Text output
  let output='National Council Seat Assignments:\n';
  seatAssignments.forEach(s=>{output+=`Seat ${s[0]}: ${s[1]} → ${s[2]}${s[3]?` (${s[3]})`:''}\n`;});
  output+='\nSeat Totals (including vacant seats):\n'; councilParties.forEach(p=>output+=`${p}: ${councilSeats[p]}\n`);
  output+='\nOccupied Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${occupiedByParty[p]}\n`);
  output+='\nVacant Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${vacantByParty[p]}\n`);
  output+=`\nTotal Occupied Seats: ${Object.values(occupiedByParty).reduce((a,b)=>a+b,0)}\n`;
  output+=`Total Vacant Seats: ${Object.values(vacantByParty).reduce((a,b)=>a+b,0)}\n`;
  output+=`Total Seats Assigned: ${assignedSeats}\nNext Party in Line: ${nextPartyGlobal}`;
  document.getElementById('results').textContent=output;

  drawSeatGrid(seatAssignmentsGlobal,assignedSeats,'seatCanvas',true);
  drawSortedSeatGrid(seatAssignmentsGlobal,councilSeats,'seatCanvasSorted',true);
}

// --- Seat grid ---
function drawSeatGrid(seats,totalSeats,canvasId,showLegend){
  const canvas=document.getElementById(canvasId), ctx=canvas.getContext('2d');
  const seatSize=60, padding=6, seatsPerRow=Math.min(10,totalSeats), rows=Math.ceil(totalSeats/seatsPerRow);
  canvas.width=seatsPerRow*(seatSize+padding)+padding; canvas.height=rows*(seatSize+padding)+150; ctx.clearRect(0,0,canvas.width,canvas.height);

  function wrapText(ctx,text,x,y,maxWidth,maxHeight){
    let words=text.split(' '), lines=[], line='';
    for(let n=0;n<words.length;n++){const testLine=line+words[n]+' '; if(ctx.measureText(testLine).width>maxWidth && n>0){lines.push(line.trim()); line=words[n]+' ';} else line=testLine;}
    lines.push(line.trim());
    let fontSize=10,lineHeight=fontSize*1.2;
    while(lineHeight*lines.length>maxHeight && fontSize>6){fontSize--; lineHeight=fontSize*1.2;} ctx.font=fontSize+'px Arial';
    let startY=y-(lineHeight*(lines.length-1))/2; lines.forEach((l,i)=>ctx.fillText(l,x,startY+i*lineHeight));
  }

  seats.forEach((seat,i)=>{
    const row=Math.floor(i/seatsPerRow), col=i%seatsPerRow, x=padding+col*(seatSize+padding), y=padding+row*(seatSize+padding);
    const partyColor=partyColorsGlobal[seat[1]]||'#888', isVacant=seat[2]==='VACANT';
    ctx.fillStyle=isVacant?'#d3d3d3':partyColor; ctx.fillRect(x,y,seatSize,seatSize);
    ctx.strokeStyle=isVacant?partyColor:'#333'; ctx.lineWidth=2; ctx.strokeRect(x,y,seatSize,seatSize);
    ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('#'+seat[0],x+seatSize/2,y+2);
    ctx.textBaseline='middle'; wrapText(ctx,isVacant?`${seat[1]} VACANT`:seat[2]+(seat[3]?` (${seat[3]})`:''),x+seatSize/2,y+seatSize/2,seatSize-4,seatSize-18);
  });

  if(showLegend){
    let startX=padding,startY=rows*(seatSize+padding)+20; ctx.textAlign='left'; ctx.font='12px Arial'; ctx.textBaseline='top';
    councilPartiesGlobal.forEach(p=>{
      ctx.fillStyle=partyColorsGlobal[p]; ctx.fillRect(startX,startY,15,15);
      ctx.fillStyle='white';
      ctx.fillText(`${p}: ${occupiedByPartyGlobal[p]} occupied, ${vacantByPartyGlobal[p]} vacant`,startX+20,startY);
      startY+=20;
    });
    ctx.fillStyle='white'; ctx.fillText(`Next Party in Line: ${nextPartyGlobal}`,startX,startY+5);
  }
}

// Sorted seat grid
function drawSortedSeatGrid(seats,councilSeats,canvasId,showLegend){
  const canvas=document.getElementById(canvasId), ctx=canvas.getContext('2d');
  const seatSize=60, padding=6, totalSeats=seats.length, seatsPerRow=Math.min(10,totalSeats), rows=Math.ceil(totalSeats/seatsPerRow);
  canvas.width=seatsPerRow*(seatSize+padding)+padding; canvas.height=rows*(seatSize+padding)+150; ctx.clearRect(0,0,canvas.width,canvas.height);

  const occupiedSeats=seats.filter(s=>s[2]!=='VACANT'), vacantSeats=seats.filter(s=>s[2]==='VACANT');
  occupiedSeats.sort((a,b)=>councilSeats[b[1]]-councilSeats[a[1]]||a[1].localeCompare(b[1]));
  const sortedSeats=[...occupiedSeats,...vacantSeats];

  function wrapText(ctx,text,x,y,maxWidth,maxHeight){
    let words=text.split(' '), lines=[], line='';
    for(let n=0;n<words.length;n++){const testLine=line+words[n]+' '; if(ctx.measureText(testLine).width>maxWidth && n>0){lines.push(line.trim()); line=words[n]+' ';} else line=testLine;}
    lines.push(line.trim());
    let fontSize=10,lineHeight=fontSize*1.2;
    while(lineHeight*lines.length>maxHeight && fontSize>6){fontSize--; lineHeight=fontSize*1.2;} ctx.font=fontSize+'px Arial';
    let startY=y-(lineHeight*(lines.length-1))/2; lines.forEach((l,i)=>ctx.fillText(l,x,startY+i*lineHeight));
  }

  sortedSeats.forEach((seat,i)=>{
    const row=Math.floor(i/seatsPerRow), col=i%seatsPerRow, x=padding+col*(seatSize+padding), y=padding+row*(seatSize+padding);
    const partyColor=partyColorsGlobal[seat[1]]||'#888', isVacant=seat[2]==='VACANT';
    ctx.fillStyle=isVacant?'#d3d3d3':partyColor; ctx.fillRect(x,y,seatSize,seatSize);
    ctx.strokeStyle=isVacant?partyColor:'#333'; ctx.lineWidth=2; ctx.strokeRect(x,y,seatSize,seatSize);
    ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('#'+seat[0],x+seatSize/2,y+2);
    ctx.textBaseline='middle'; wrapText(ctx,isVacant?`${seat[1]} VACANT`:seat[2]+(seat[3]?` (${seat[3]})`:''),x+seatSize/2,y+seatSize/2,seatSize-4,seatSize-18);
  });

  if(showLegend){
    let startX=padding,startY=rows*(seatSize+padding)+20; ctx.textAlign='left'; ctx.font='12px Arial'; ctx.textBaseline='top';
    councilPartiesGlobal.forEach(p=>{
      ctx.fillStyle=partyColorsGlobal[p]; ctx.fillRect(startX,startY,15,15);
      ctx.fillStyle='white';
      ctx.fillText(`${p}: ${occupiedByPartyGlobal[p]} occupied, ${vacantByPartyGlobal[p]} vacant`,startX+20,startY);
      startY+=20;
    });
    ctx.fillStyle='white'; ctx.fillText(`Next Party in Line: ${nextPartyGlobal}`,startX,startY+5);
  }
}

// Export
function exportCSV(){const text=document.getElementById('results').textContent.replace(/\n/g,'\r\n'); const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='allocation_results.txt'; a.click();}
function downloadSeatImage(){const canvas=document.getElementById('seatCanvas'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='seat_grid.png'; link.click();}
function downloadSortedSeatImage(){const canvas=document.getElementById('seatCanvasSorted'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='sorted_seat_grid.png'; link.click();}
</script>
</body>
</html>
