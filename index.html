<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator with Factions</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e1e; color: #fff; }
h1,h2 { margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 6px; color: #000; background:#fff; }
th, td { padding: 6px 8px; border: 1px solid #ccc; font-size: 13px; }
input[type="text"], input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; }
input[type="color"] { width: 48px; height: 32px; border: none; cursor: pointer; }
button { padding: 6px 10px; border-radius: 6px; border: 1px solid #cfcfcf; background: #f0f0f0; cursor: pointer; color: #000;}
button.primary { background: #2d6cdf; color: #fff; border-color: #2a63d6; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; align-items: center; }
pre#results { max-height: 300px; overflow: auto; background: #222; padding: 10px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; color: #fff;}
canvas { border:1px solid #ccc; margin-top:10px; border-radius:6px; background: transparent; }
</style>
</head>
<body>

<h1>National Council Seat Allocator (Factions Enabled)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
<thead><tr><th>Party Name</th><th>Votes</th><th>Color</th><th>Action</th></tr></thead>
<tbody id="houseBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
<thead><tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="partyListBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="text" value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="text" value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi- ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="text" value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="text" value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party</button>

<h2>Faction Lists</h2>
<table id="factionTable">
<thead><tr><th>Party Name</th><th>Faction Name</th><th>Votes</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="factionBody">
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Communist"></td><td><input type="number" value="2"></td><td><input type="text" value="Dreamersk, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addFactionRow()">+ Add Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats: <input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% votes required): <input type="number" id="threshold" value="5" min="0" max="100"></label><br>

<div class="controls">
  <button class="primary" onclick="allocateSeats()">Allocate Seats</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="downloadSeatImage()">Download Seat Grid Image</button>
  <button onclick="downloadSortedSeatImage()">Download Sorted Seat Grid Image</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Original Seat Grid</h2>
<canvas id="seatCanvas"></canvas>

<h2>Sorted Seat Grid (Largest Party → Smallest, Vacants Last)</h2>
<canvas id="seatCanvasSorted"></canvas>

<script>
// --- Table helpers ---
function deleteRow(btn){btn.closest('tr').remove();}
function addHouseRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="number" min="0"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('houseBody').appendChild(tr);}
function addPartyListRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('partyListBody').appendChild(tr);}
function addFactionRow(){const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text"></td><td><input type="text"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>'; document.getElementById('factionBody').appendChild(tr);}

// --- Global data ---
let seatAssignmentsGlobal=[], councilSeatsGlobal={}, partyColorsGlobal={}, councilPartiesGlobal=[], occupiedByPartyGlobal={}, vacantByPartyGlobal={}, nextPartyGlobal='';

// --- Allocation function ---
function allocateSeats(){
  const houseResults={}, partyColors={}, partyOrder=[], partyLists={}, factionLists={};
  let totalVotes=0;

  document.querySelectorAll('#houseTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input'); 
    const party=inputs[0].value.trim(); 
    const votes=parseInt(inputs[1].value)||0; 
    const color=inputs[2].value||'#888888';
    if(party){houseResults[party]=votes; partyColors[party]=color; partyOrder.push(party); totalVotes+=votes;}
  });

  document.querySelectorAll('#partyListTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input'); 
    const party=inputs[0].value.trim(); 
    if(party){partyLists[party]=inputs[1].value.split(',').map(s=>s.trim()).filter(Boolean);}
  });

  document.querySelectorAll('#factionTable tbody tr').forEach(row=>{
    const inputs=row.querySelectorAll('input'); 
    const party=inputs[0].value.trim(); 
    const faction=inputs[1].value.trim();
    const votes=parseInt(inputs[2].value)||0;
    const candidates=inputs[3].value.split(',').map(s=>s.trim()).filter(Boolean);
    if(party && faction){if(!factionLists[party]) factionLists[party]=[]; factionLists[party].push({name:faction,votes:votes,candidates:candidates}); totalVotes+=votes; }
  });

  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacantSeats=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||1000;

  const councilParties=[], councilSeats={}, occupiedByParty={}, vacantByParty={};
  for(const p of partyOrder){
    const partyTotalVotes=(houseResults[p]||0)+((factionLists[p]||[]).reduce((a,f)=>a+f.votes,0));
    if(totalVotes>0 && (partyTotalVotes/totalVotes*100)<threshold) continue;
    councilParties.push(p); councilSeats[p]=0; occupiedByParty[p]=0; vacantByParty[p]=0;
  }
  if(councilParties.length===0){document.getElementById('results').textContent='No parties meet the threshold.'; return;}

  // D'Hondt allocation
  const seatAssignments=[]; let assignedSeats=0, vacantSeats=0, occupiedSeats=0;
  const remainingLists={};
  councilParties.forEach(p=>{remainingLists[p]={main:[...partyLists[p]||[]],factions:(factionLists[p]||[]).map(f=>({...f,candidates:[...f.candidates]}))};});

  function getNextFactionCandidate(p){
    const partyData=remainingLists[p];
    const partyTotalVotes=(houseResults[p]||0)+partyData.factions.reduce((a,f)=>a+f.votes,0);
    const options=[{name:'Main',votes:houseResults[p]||0,candidates:partyData.main}].concat(partyData.factions.map(f=>({...f})));
    options.sort((a,b)=>{
      const fracA=(a.votes||0)/partyTotalVotes; const fracB=(b.votes||0)/partyTotalVotes;
      if(fracB!==fracA) return fracB-fracA;
      if(a.name==='Main') return -1;
      if(b.name==='Main') return 1;
      return a.name.localeCompare(b.name);
    });
    for(const f of options){if(f.candidates.length>0) return {faction:f.name,candidate:f.candidates.shift()};}
    return {faction:options[0].name,candidate:null};
  }

  while(vacantSeats<requiredVacantSeats && assignedSeats<maxSeats){
    const quotients={};
    councilParties.forEach(p=>quotients[p]=(houseResults[p]||0 + (factionLists[p]||[]).reduce((a,f)=>a+f.votes,0))/(councilSeats[p]+1));
    const nextParty=Object.keys(quotients).reduce((a,b)=>quotients[a]>=quotients[b]?a:b);
    assignedSeats++; councilSeats[nextParty]++;
    const nextCand=getNextFactionCandidate(nextParty);
    if(nextCand.candidate){seatAssignments.push([assignedSeats,nextParty,nextCand.candidate,nextCand.faction]); occupiedSeats++; occupiedByParty[nextParty]++;}
    else{seatAssignments.push([assignedSeats,nextParty,'VACANT',nextCand.faction]); vacantSeats++; vacantByParty[nextParty]++;}
  }

  // Next in line
  const nextQuotients={};
  councilParties.forEach(p=>nextQuotients[p]=(houseResults[p]||0 + (factionLists[p]||[]).reduce((a,f)=>a+f.votes,0))/(councilSeats[p]+1));
  nextPartyGlobal=Object.keys(nextQuotients).reduce((a,b)=>nextQuotients[a]>=nextQuotients[b]?a:b);

  // Store globally
  seatAssignmentsGlobal=seatAssignments; councilSeatsGlobal=councilSeats; partyColorsGlobal=partyColors;
  councilPartiesGlobal=councilParties; occupiedByPartyGlobal=occupiedByParty; vacantByPartyGlobal=vacantByParty;

  // Display results
  let output='National Council Seat Assignments:\n';
  seatAssignments.forEach(([num,party,candidate,faction])=>output+=`Seat ${num}: ${party}${faction!=='Main'?' ('+faction+')':''} → ${candidate}\n`);
  output+='\nSeat Totals (including vacant seats):\n'; councilParties.forEach(p=>output+=`${p}: ${councilSeats[p]}\n`);
  output+='\nOccupied Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${occupiedByParty[p]}\n`);
  output+='\nVacant Seats by Party:\n'; councilParties.forEach(p=>output+=`${p}: ${vacantByParty[p]}\n`);
  output+=`\nTotal Occupied Seats: ${occupiedSeats}\nTotal Vacant Seats: ${vacantSeats}\nTotal Seats Assigned: ${assignedSeats}\n`;
  output+=`\n📌 Next Party in Line: ${nextPartyGlobal}`;
  document.getElementById('results').textContent=output;

  drawSeatGrid(seatAssignmentsGlobal,assignedSeats,'seatCanvas',true);
  drawSortedSeatGrid(seatAssignmentsGlobal,councilSeatsGlobal,'seatCanvasSorted',true);
}

// --- Drawing functions ---
// Include your fully working canvas grid functions from previous version, with wrapping text, faction names, vacants, legends in white.
// For brevity, you can copy-paste your previous `drawSeatGrid` and `drawSortedSeatGrid` code here (they will work with this data).

// --- Export functions ---
function exportCSV(){const text=document.getElementById('results').textContent.replace(/\n/g,'\r\n'); const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='allocation_results.txt'; a.click();}
function downloadSeatImage(){const canvas=document.getElementById('seatCanvas'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='seat_grid.png'; link.click();}
function downloadSortedSeatImage(){const canvas=document.getElementById('seatCanvasSorted'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='sorted_seat_grid.png'; link.click();}
</script>
</body>
</html>
