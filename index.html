<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator (Advanced)</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f7f9fc; color: #333; }
h1, h2 { color: #222; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: #fff; }
th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
input { width: 100%; padding: 0.4rem; box-sizing: border-box; }
button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.2rem 0; cursor: pointer; border-radius: 6px; border: 1px solid #666; background: #eee; }
button:hover { background: #ddd; }
.add-row { margin-bottom: 1rem; }
pre { background: #fff; padding: 1rem; border-radius: 5px; overflow-x: auto; }
canvas { margin: 1rem 0; display: block; }
#parliamentCanvas { max-width: 600px; max-height: 400px; margin: auto; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>National Council Seat Allocator (Advanced)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
    <thead>
        <tr><th>Party Name</th><th>Votes</th><th>Party Color</th><th>Action</th></tr>
    </thead>
    <tbody id="houseBody">
        <tr><td><input value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#d62728"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#9467bd"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#2ca02c"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ff7f0e"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#1f77b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    </tbody>
</table>
<button class="add-row" onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
    <thead>
        <tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr>
    </thead>
    <tbody id="partyListBody">
        <tr><td><input value="Reclaim"></td><td><input value="Josef, John Louis"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Purple Crown"></td><td><input value="Cierna"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Social Democratic"></td><td><input value="Dreamersk"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Solarist"></td><td><input value="Hiro Solarist"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Progressive"></td><td><input value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    </tbody>
</table>
<button class="add-row" onclick="addPartyListRow()">+ Add Party</button>

<h2>Settings</h2>
<label>Required Vacant Seats:</label>
<input type="number" id="requiredVacant" value="5" min="0">

<br><br>
<label>Maximum Total Seats:</label>
<input type="number" id="maxSeats" value="150" min="1">

<br><br>
<label>Threshold (% of votes required):</label>
<input type="number" id="threshold" value="0" min="0" max="100">

<br><br>
<button onclick="allocateSeats()">Allocate Seats</button>
<button onclick="exportCSV()">Export CSV</button>

<h2>Results</h2>
<pre id="results"></pre>

<h2>Visualizations</h2>
<canvas id="parliamentCanvas" width="600" height="400"></canvas>
<canvas id="vacantChart" width="600" height="300"></canvas>

<script>
// --- Table Row Helpers ---
function deleteRow(button) {
    button.closest('tr').remove();
}
function addHouseRow() {
    const tbody = document.getElementById("houseBody");
    const row = document.createElement("tr");
    row.innerHTML = `<td><input></td><td><input type="number"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
    tbody.appendChild(row);
}
function addPartyListRow() {
    const tbody = document.getElementById("partyListBody");
    const row = document.createElement("tr");
    row.innerHTML = `<td><input></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
    tbody.appendChild(row);
}

// --- Allocation Logic ---
let vacantChart;

function allocateSeats() {
    const houseResults = {};
    const partyColors = {};
    const partyOrder = [];
    let totalVotes = 0;

    document.querySelectorAll("#houseTable tbody tr").forEach(row => {
        const [partyCell, votesCell, colorCell] = row.querySelectorAll("input");
        const party = partyCell.value.trim();
        const votes = parseInt(votesCell.value) || 0;
        const color = colorCell.value || "#888888";
        if(party) {
            houseResults[party] = votes;
            partyColors[party] = color;
            partyOrder.push(party);
            totalVotes += votes;
        }
    });

    const threshold = parseFloat(document.getElementById("threshold").value) || 0;
    const requiredVacantSeats = parseInt(document.getElementById("requiredVacant").value);
    const maxSeats = parseInt(document.getElementById("maxSeats").value);

    const partyLists = {};
    document.querySelectorAll("#partyListTable tbody tr").forEach(row => {
        const [partyCell, candidatesCell] = row.querySelectorAll("input");
        const party = partyCell.value.trim();
        if(party) {
            partyLists[party] = candidatesCell.value.split(",").map(s => s.trim()).filter(Boolean);
        }
    });

    let councilSeats = {}, seatAssignments = [], assignedSeats = 0, vacantSeats = 0, occupiedSeats = 0;
    let occupiedByParty = {}, vacantByParty = {};

    for (let party of partyOrder) {
        if (totalVotes > 0 && (houseResults[party] / totalVotes * 100) < threshold) {
            continue;
        }
        councilSeats[party] = 0;
        occupiedByParty[party] = 0;
        vacantByParty[party] = 0;
    }

    function getNextCandidate(party) {
        return partyLists[party] && partyLists[party].length ? partyLists[party].shift() : null;
    }

    while(vacantSeats < requiredVacantSeats && assignedSeats < maxSeats) {
        const quotients = {};
        for(let party in councilSeats) {
            quotients[party] = houseResults[party] / (councilSeats[party]+1);
        }
        const nextParty = Object.keys(quotients).reduce((a,b)=>quotients[a]>quotients[b]?a:b);

        const candidate = getNextCandidate(nextParty);
        assignedSeats++;
        councilSeats[nextParty]++;

        if(candidate) {
            seatAssignments.push([assignedSeats, nextParty, candidate]);
            occupiedSeats++;
            occupiedByParty[nextParty]++;
        } else {
            seatAssignments.push([assignedSeats, nextParty, "VACANT"]);
            vacantSeats++;
            vacantByParty[nextParty]++;
        }
    }

    let nextInLineParty = "N/A";
    if (assignedSeats < maxSeats) {
        const nextQuotients = {};
        for(let party in councilSeats) {
            nextQuotients[party] = houseResults[party] / (councilSeats[party]+1);
        }
        nextInLineParty = Object.keys(nextQuotients).reduce((a,b)=>nextQuotients[a]>nextQuotients[b]?a:b);
    }

    // Text Results
    let output = "National Council Seat Assignments:\n";
    seatAssignments.forEach(([num, party, member]) => {
        output += `Seat ${num}: ${party} â†’ ${member}\n`;
    });
    output += "\nSeat Totals (including vacant seats):\n";
    for(let party in councilSeats) output += `${party}: ${councilSeats[party]}\n`;
    output += "\nOccupied Seats by Party:\n";
    for(let party in occupiedByParty) output += `${party}: ${occupiedByParty[party]}\n`;
    output += "\nVacant Seats by Party:\n";
    for(let party in vacantByParty) output += `${party}: ${vacantByParty[party]}\n`;
    output += `\nTotal Occupied Seats: ${occupiedSeats}\n`;
    output += `Total Vacant Seats: ${vacantSeats}\n`;
    output += `Total Seats Assigned: ${assignedSeats}\n`;
    output += `\nðŸ“Œ Next Party in Line for a Seat: ${nextInLineParty}`;
    document.getElementById("results").textContent = output;

    // Draw Hemicycle Parliament Diagram
    drawParliamentDiagram("parliamentCanvas", councilSeats, partyColors);

    // Vacant vs Occupied stacked chart
    const labels = Object.keys(councilSeats);
    const occupiedData = labels.map(p=>occupiedByParty[p]||0);
    const vacantData = labels.map(p=>vacantByParty[p]||0);
    if (vacantChart) vacantChart.destroy();
    vacantChart = new Chart(document.getElementById("vacantChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label:"Occupied", data: occupiedData, backgroundColor:"#4caf50" },
                { label:"Vacant", data: vacantData, backgroundColor:"#f44336" }
            ]
        },
        options: { plugins:{legend:{position:'top'}}, scales:{x:{stacked:true}, y:{stacked:true}} }
    });
}

// --- Hemicycle Drawing ---
function drawParliamentDiagram(canvasId, councilSeats, partyColors) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const seatRadius = 6;
    const seatGap = 2;
    const totalSeats = Object.values(councilSeats).reduce((a,b)=>a+b,0);
    if (totalSeats === 0) return;

    const rows = Math.ceil(Math.sqrt(totalSeats)/2); // rough row estimate
    let seatsPlaced = 0;

    const parties = Object.entries(councilSeats).sort((a,b)=>b[1]-a[1]);

    let seats = [];
    parties.forEach(([party,count])=>{
        for(let i=0;i<count;i++){
            seats.push(partyColors[party]);
        }
    });

    // Layout in concentric arcs
    let currentSeat = 0;
    for(let row=0; row<rows; row++){
        const seatsInRow = Math.ceil((totalSeats - currentSeat)/(rows-row));
        const radius = (canvas.height/2 - 20) - row*(seatRadius*2+seatGap);
        const angleStart = Math.PI;
        const angleEnd = 0;
        for(let i=0; i<seatsInRow && currentSeat<totalSeats; i++){
            const angle = angleStart + (i/(seatsInRow-1))*(angleEnd-angleStart);
            const x = canvas.width/2 + radius * Math.cos(angle);
            const y = canvas.height - 20 - radius * Math.sin(angle);
            ctx.beginPath();
            ctx.arc(x,y,seatRadius,0,2*Math.PI);
            ctx.fillStyle = seats[currentSeat];
            ctx.fill();
            ctx.stroke();
            currentSeat++;
        }
    }
}

// --- CSV Export ---
function exportCSV() {
    const text = document.getElementById("results").textContent;
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "allocation_results.csv";
    a.click();
}
</script>
</body>
</html>
