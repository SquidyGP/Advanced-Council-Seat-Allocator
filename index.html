<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator with Factions</title>
<style>
body { font-family: Arial, sans-serif; margin: 1rem; background: #f7f9fc; color: #333; }
h1, h2 { margin-top: 1rem; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: #fff; }
th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: left; }
input { padding: 0.3rem; }
button { padding: 0.4rem 0.8rem; margin: 0.2rem 0; cursor: pointer; }
canvas { margin: 1rem 0; border:1px solid #444; }
pre { background: #fff; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>National Council Seat Allocator (with Factions)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
  <thead>
    <tr><th>Party Name</th><th>Votes</th><th>Party Color</th><th>Action</th></tr>
  </thead>
  <tbody id="houseBody">
    <tr><td><input value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party & Faction Lists</h2>
<table id="partyListTable">
  <thead>
    <tr><th>Party Name</th><th>Faction (optional)</th><th>Faction Votes</th><th>Candidates (comma-separated)</th><th>Action</th></tr>
  </thead>
  <tbody id="partyListBody">
    <tr><td><input value="Reclaim"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi- ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party/Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5"></label><br>
<label>Maximum Total Seats: <input type="number" id="maxSeats" value="150"></label><br>
<label>Threshold (%): <input type="number" id="threshold" value="5"></label><br>
<button onclick="allocateSeats()">Allocate Seats</button>

<h2>Results</h2>
<pre id="results"></pre>

<h2>Seat Grids</h2>
<p>Original Allocation Order:</p>
<canvas id="seatCanvas"></canvas>
<p>Sorted by Party Size (vacants last):</p>
<canvas id="seatCanvasSorted"></canvas>

<script>
// Helpers
function deleteRow(btn){btn.closest("tr").remove();}
function addHouseRow(){
  const r=document.createElement("tr");
  r.innerHTML=`<td><input></td><td><input type="number"></td><td><input type="color" value="#888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  document.getElementById("houseBody").appendChild(r);
}
function addPartyListRow(){
  const r=document.createElement("tr");
  r.innerHTML=`<td><input></td><td><input></td><td><input type="number" value="0"></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  document.getElementById("partyListBody").appendChild(r);
}

// Allocation
function allocateSeats(){
  const parties={},colors={},partyOrder=[];
  let totalVotes=0;
  document.querySelectorAll("#houseTable tbody tr").forEach(r=>{
    const [p,v,c]=r.querySelectorAll("input");
    const party=p.value.trim(),votes=parseInt(v.value)||0,color=c.value;
    if(party){parties[party]={votes, factions:[], candidates:[], totalVotes:0}; colors[party]=color; partyOrder.push(party); totalVotes+=votes;}
  });

  document.querySelectorAll("#partyListTable tbody tr").forEach(r=>{
    const [p,f,v,c]=r.querySelectorAll("input");
    const party=p.value.trim(), faction=f.value.trim(), votes=parseInt(v.value)||0, cands=c.value.split(",").map(s=>s.trim()).filter(Boolean);
    if(!party)return;
    if(faction){
      parties[party].factions.push({name:faction,votes,candidates:cands});
      parties[party].totalVotes+=votes;
    } else {
      parties[party].candidates=cands;
      parties[party].totalVotes+=votes;
    }
  });

  // add base party votes
  for(let p in parties) parties[p].totalVotes+=parties[p].votes;

  const threshold=parseFloat(document.getElementById("threshold").value)||0;
  const requiredVacant=parseInt(document.getElementById("requiredVacant").value)||0;
  const maxSeats=parseInt(document.getElementById("maxSeats").value)||100;

  // filter threshold
  const eligible={};
  for(let p of partyOrder){
    if(totalVotes>0 && (parties[p].totalVotes/totalVotes*100)<threshold) continue;
    eligible[p]=0;
  }

  let assignments=[],assigned=0,vacantCount=0;
  function getNextCandidate(partyObj,factionName){
    let src;
    if(factionName){
      src=partyObj.factions.find(f=>f.name===factionName);
      if(src&&src.candidates.length) return src.candidates.shift();
      return null;
    } else {
      if(partyObj.candidates.length) return partyObj.candidates.shift();
      return null;
    }
  }

  while(assigned<maxSeats && vacantCount<requiredVacant){
    const quot={};
    for(let p in eligible){
      quot[p]=parties[p].votes/(eligible[p]+1);
    }
    const nextParty=Object.keys(quot).reduce((a,b)=>quot[a]>quot[b]?a:b);
    eligible[nextParty]++;
    assigned++;

    // internal faction allocation
    let chosen="main";
    const subs=[{name:"main",votes:parties[nextParty].votes}].concat(parties[nextParty].factions.map(f=>({name:f.name,votes:f.votes})));
    let subSeats={}; subs.forEach(s=>subSeats[s.name]=0);

    // assign which sub gets this seat
    const subQuot={};
    for(let s of subs){ subQuot[s.name]=s.votes/(subSeats[s.name]+1); }
    chosen=Object.keys(subQuot).reduce((a,b)=>subQuot[a]>subQuot[b]?a:b);
    subSeats[chosen]++;

    const cand=getNextCandidate(parties[nextParty],chosen==="main"?null:chosen);
    if(cand){ assignments.push([assigned,nextParty+(chosen==="main"?"":` (${chosen})`),cand]); }
    else { assignments.push([assigned,nextParty+(chosen==="main"?"":` (${chosen})`),"VACANT"]); vacantCount++; }
  }

  let txt="National Council Seat Assignments:\n";
  assignments.forEach(([n,p,m])=>txt+=`Seat ${n}: ${p} → ${m}\n`);
  document.getElementById("results").textContent=txt;

  drawSeatGrid(assignments,"seatCanvas",colors);
  // sort by party totals (stable)
  const sorted=[...assignments].sort((a,b)=>{
    const pa=a[1].split(" (")[0], pb=b[1].split(" (")[0];
    if(parties[pa].totalVotes!==parties[pb].totalVotes) return parties[pb].totalVotes-parties[pa].totalVotes;
    if(a[2]==="VACANT" && b[2]!=="VACANT") return 1;
    if(b[2]==="VACANT" && a[2]!=="VACANT") return -1;
    return a[0]-b[0];
  });
  drawSeatGrid(sorted,"seatCanvasSorted",colors);
}

// Draw seat grid
function drawSeatGrid(assignments,id,colors){
  const can=document.getElementById(id),ctx=can.getContext("2d");
  const cols=15,size=50; const rows=Math.ceil(assignments.length/cols);
  can.width=cols*size; can.height=rows*size;
  ctx.clearRect(0,0,can.width,can.height);
  assignments.forEach(([num,party,member],i)=>{
    const x=(i%cols)*size,y=Math.floor(i/cols)*size;
    const base=party.split(" (")[0];
    ctx.fillStyle=colors[base]||"#999";
    ctx.fillRect(x,y,size,size);
    ctx.strokeRect(x,y,size,size);
    ctx.fillStyle="#000";
    ctx.font="9px sans-serif";
    ctx.fillText(num,x+2,y+10);
    ctx.fillText(member.length>8?member.slice(0,8)+"…":member,x+2,y+22);
    ctx.fillText(party.length>8?party.slice(0,8)+"…":party,x+2,y+34);
  });
}
</script>
</body>
</html>
