<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>National Council Seat Allocator (Advanced)</title>
<style>
  body{font-family:Arial,sans-serif; margin:20px; background:#f7f9fc; color:#222;}
  h1{margin-bottom:8px;} h2{margin:16px 0 8px;}
  table{width:100%; border-collapse:collapse; margin-top:6px;}
  th,td{padding:6px 8px; border:1px solid #e6e9ef; font-size:13px; vertical-align:middle;}
  input[type="number"], input[type="text"]{padding:6px; width:100%; box-sizing:border-box;}
  input[type="color"]{height:28px;width:40px;border:none; cursor:pointer;}
  button{padding:6px 10px; border-radius:6px; border:1px solid #cfcfcf; background:#f0f0f0; cursor:pointer;}
  button.primary{background:#2d6cdf;color:#fff;border-color:#2a63d6;}
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; align-items:center}
  pre#results{max-height:300px; overflow:auto; background:#fcfcff; padding:10px; border-radius:6px; border:1px solid #e7e9ef; font-size:13px; white-space:pre-wrap;}
  canvas{width:100%; max-width:720px; margin:12px 0;}
  .legend{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center;}
  .legend-item{display:flex; gap:6px; align-items:center; font-size:13px;}
  .color-box{width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.08);}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>National Council Seat Allocator (Advanced)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
<thead><tr><th>Party Name</th><th>Votes</th><th>Color</th><th>Action</th></tr></thead>
<tbody id="houseBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#d62728"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#9467bd"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#2ca02c"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ff7f0e"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#1f77b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
<thead><tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr></thead>
<tbody id="partyListBody">
<tr><td><input type="text" value="Reclaim"></td><td><input type="text" value="Josef, John Louis"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Purple Crown"></td><td><input type="text" value="Cierna"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Social Democratic"></td><td><input type="text" value="Dreamersk"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Solarist"></td><td><input type="text" value="Hiro Solarist"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
<tr><td><input type="text" value="Progressive"></td><td><input type="text" value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
</tbody>
</table>
<button onclick="addPartyListRow()">+ Add Party</button>

<h2>Settings</h2>
<label>Required Vacant Seats:<input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats:<input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% of votes required):<input type="number" id="threshold" value="0" min="0" max="100"></label><br>
<div class="controls">
<button class="primary" onclick="allocateSeats()">Allocate Seats</button>
<button onclick="exportCSV()">Export CSV</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Visualizations</h2>
<canvas id="occupiedArc" height="280"></canvas>
<canvas id="totalArc" height="280"></canvas>
<div id="legend" class="legend"></div>

<script>
// --- helpers ---
function deleteRow(btn){btn.closest('tr').remove();}
function addHouseRow(){const t=document.getElementById('houseBody'),r=document.createElement('tr'); r.innerHTML=`<td><input type="text"></td><td><input type="number" min="0"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;t.appendChild(r);}
function addPartyListRow(){const t=document.getElementById('partyListBody'),r=document.createElement('tr');r.innerHTML=`<td><input type="text"></td><td><input type="text"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;t.appendChild(r);}

// --- allocation ---
let occupiedChart=null,totalChart=null;
function allocateSeats(){
  const houseResults={}, partyColors={}, partyOrder=[], partyLists={};
  let totalVotes=0;
  document.querySelectorAll('#houseTable tbody tr').forEach(r=>{
    const inputs=r.querySelectorAll('input'),p=inputs[0].value.trim(),v=parseInt(inputs[1].value)||0,c=inputs[2].value||'#888';
    if(p){houseResults[p]=v; partyColors[p]=c; partyOrder.push(p); totalVotes+=v;}
  });
  document.querySelectorAll('#partyListTable tbody tr').forEach(r=>{
    const inputs=r.querySelectorAll('input'),p=inputs[0].value.trim();
    if(p){partyLists[p]=inputs[1].value.split(',').map(s=>s.trim()).filter(Boolean);}
  });

  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacant=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||1000;

  const councilParties=[],councilSeats={},occupiedByParty={},vacantByParty={};
  for(const p of partyOrder){
    if(totalVotes>0 && (houseResults[p]/totalVotes*100)<threshold) continue;
    councilParties.push(p); councilSeats[p]=0; occupiedByParty[p]=0; vacantByParty[p]=0;
  }

  if(councilParties.length===0){document.getElementById('results').textContent='No parties meet threshold'; return;}

  function getNextCandidate(p){return partyLists[p]&&partyLists[p].length?partyLists[p].shift():null;}
  const seatAssignments=[]; let assignedSeats=0,occupiedSeats=0,vacantSeats=0;

  while(vacantSeats<requiredVacant && assignedSeats<maxSeats){
    let maxQ=-Infinity, nextP=councilParties[0];
    for(const p of councilParties){const q=houseResults[p]/(councilSeats[p]+1); if(q>maxQ){maxQ=q;nextP=p;}}
    const cand=getNextCandidate(nextP); assignedSeats++; councilSeats[nextP]++;
    if(cand){seatAssignments.push([assignedSeats,nextP,cand]); occupiedSeats++; occupiedByParty[nextP]++;} 
    else {seatAssignments.push([assignedSeats,nextP,'VACANT']); vacantSeats++; vacantByParty[nextP]++;}
  }

  let nextInLine='N/A';
  if(assignedSeats<maxSeats){
    let maxQ=-Infinity;
    for(const p of councilParties){const q=houseResults[p]/(councilSeats[p]+1); if(q>maxQ){maxQ=q; nextInLine=p;}}
  }

  let output='National Council Seat Assignments:\\n';
  for(const [num,party,member] of seatAssignments) output+=`Seat ${num}: ${party} â†’ ${member}\\n`;
  output+='\\nSeat Totals (including vacant seats):\\n'; for(const p of councilParties) output+=`${p}: ${councilSeats[p]}\\n`;
  output+='\\nOccupied Seats by Party:\\n'; for(const p of councilParties) output+=`${p}: ${occupiedByParty[p]}\\n`;
  output+='\\nVacant Seats by Party:\\n'; for(const p of councilParties) output+=`${p}: ${vacantByParty[p]}\\n`;
  output+=`\\nTotal Occupied Seats: ${occupiedSeats}\\nTotal Vacant Seats: ${vacantSeats}\\nTotal Seats Assigned: ${assignedSeats}\\n`;
  output+=`\\nðŸ“Œ Next Party in Line: ${nextInLine}`;
  document.getElementById('results').textContent=output;

  // build data for arcs
  const sorted = Object.entries(councilSeats).sort((a,b)=>b[1]-a[1]);
  const labels=[], occData=[], totalData=[], colors=[];
  for(const [p,count] of sorted){
    if(count>0){labels.push(p); occData.push(occupiedByParty[p]); totalData.push(count); colors.push(partyColors[p]||'#888');}
  }

  // Occupied seats arc
  if(occupiedChart) occupiedChart.destroy();
  occupiedChart = new Chart(document.getElementById('occupiedArc'),{
    type:'doughnut',
    data:{labels, datasets:[{data:occData, backgroundColor:colors}]},
    options:{
      rotation: Math.PI,
      circumference: Math.PI,
      plugins:{legend:{display:true, position:'bottom', labels:{usePointStyle:true}}}
    }
  });

  // Total seats arc
  if(totalChart) totalChart.destroy();
  totalChart = new Chart(document.getElementById('totalArc'),{
    type:'doughnut',
    data:{labels, datasets:[{data:totalData, backgroundColor:colors}]},
    options:{
      rotation: Math.PI,
      circumference: Math.PI,
      plugins:{legend:{display:true, position:'bottom', labels:{usePointStyle:true}}}
    }
  });
}

// CSV export
function exportCSV(){const text=document.getElementById('results').textContent||'';const blob=new Blob([text],{type:'text/plain;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='allocation_results.txt';a.click();}
</script>
</body>
</html>
