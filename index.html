<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator (with Factions)</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f7f9fc; color: #333; }
h1, h2 { color: #222; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: #fff; }
th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
input { width: 100%; padding: 0.4rem; box-sizing: border-box; }
button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.2rem 0; cursor: pointer; border-radius: 6px; border: 1px solid #666; background: #eee; }
button:hover { background: #ddd; }
.add-row { margin-bottom: 1rem; }
pre { background: #fff; padding: 1rem; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
canvas { margin: 1rem 0; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>National Council Seat Allocator (with Factions)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
  <thead>
    <tr><th>Party Name</th><th>Votes</th><th>Party Color</th><th>Action</th></tr>
  </thead>
  <tbody id="houseBody">
    <tr><td><input value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button class="add-row" onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
  <thead>
    <tr><th>Party Name</th><th>Faction (leave blank if none)</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr>
  </thead>
  <tbody id="partyListBody">
    <tr><td><input value="Reclaim"></td><td><input value=""></td><td><input value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input value=""></td><td><input value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input value=""></td><td><input value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi- ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input value="Communist"></td><td><input value=""></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input value=""></td><td><input value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input value=""></td><td><input value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button class="add-row" onclick="addPartyListRow()">+ Add Party/Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats:</label>
<input type="number" id="requiredVacant" value="5" min="0"><br><br>

<label>Maximum Total Seats:</label>
<input type="number" id="maxSeats" value="150" min="1"><br><br>

<label>Threshold (% of votes required):</label>
<input type="number" id="threshold" value="5" min="0" max="100"><br><br>

<button onclick="allocateSeats()">Allocate Seats</button>
<button onclick="exportCSV()">Export CSV</button>

<h2>Results</h2>
<pre id="results"></pre>

<h2>Seat Grid (Allocation Order)</h2>
<canvas id="seatCanvas"></canvas><br>
<button onclick="downloadSeatImage()">Download Grid PNG</button>

<h2>Seat Grid (Sorted by Largest → Smallest, Vacants Last)</h2>
<canvas id="seatCanvasSorted"></canvas><br>
<button onclick="downloadSortedSeatImage()">Download Sorted Grid PNG</button>

<script>
// --- Table helpers ---
function deleteRow(button){ button.closest('tr').remove(); }
function addHouseRow(){
  const tbody=document.getElementById("houseBody");
  const row=document.createElement("tr");
  row.innerHTML=`<td><input></td><td><input type="number"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  tbody.appendChild(row);
}
function addPartyListRow(){
  const tbody=document.getElementById("partyListBody");
  const row=document.createElement("tr");
  row.innerHTML=`<td><input></td><td><input></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  tbody.appendChild(row);
}

// --- Globals ---
let partyColorsGlobal={}, councilPartiesGlobal=[], occupiedByPartyGlobal={}, vacantByPartyGlobal={}, nextPartyGlobal="";

// --- Allocation logic (with factions) ---
function allocateSeats(){
  const houseResults={}, partyColors={}, partyOrder=[]; let totalVotes=0;
  document.querySelectorAll("#houseTable tbody tr").forEach(row=>{
    const [partyCell,votesCell,colorCell]=row.querySelectorAll("input");
    const party=partyCell.value.trim(); const votes=parseInt(votesCell.value)||0; const color=colorCell.value||"#888888";
    if(party){ houseResults[party]=votes; partyColors[party]=color; partyOrder.push(party); totalVotes+=votes; }
  });

  const threshold=parseFloat(document.getElementById("threshold").value)||0;
  const requiredVacantSeats=parseInt(document.getElementById("requiredVacant").value);
  const maxSeats=parseInt(document.getElementById("maxSeats").value);

  // --- Party + faction lists ---
  const partyLists={}, factionLists={}; 
  document.querySelectorAll("#partyListTable tbody tr").forEach(row=>{
    const [partyCell,factionCell,candidatesCell]=row.querySelectorAll("input");
    const party=partyCell.value.trim(), faction=factionCell.value.trim();
    const candidates=candidatesCell.value.split(",").map(s=>s.trim()).filter(Boolean);
    if(party){
      if(faction){ if(!factionLists[party]) factionLists[party]={}; factionLists[party][faction]=candidates; }
      else { partyLists[party]=candidates; }
    }
  });

  // --- Apply threshold at PARTY level ---
  const validParties={};
  partyOrder.forEach(p=>{
    const total=houseResults[p]+(factionLists[p]?Object.values(factionLists[p]).reduce((a,b)=>a+(b.votes||0),0):0);
    if(totalVotes>0 && (total/totalVotes*100)>=threshold){
      validParties[p]=true;
    }
  });

  // For factions: gather their votes separately
  const factionVotes={};
  Object.keys(factionLists).forEach(p=>{
    factionVotes[p]={};
    Object.keys(factionLists[p]).forEach(f=>factionVotes[p][f]=0);
  });

  // Initially: assign base votes (houseResults + factions)
  const allVotes={};
  partyOrder.forEach(p=>{
    if(validParties[p]) allVotes[p]=houseResults[p];
  });

  // Add faction votes (count toward parent totals)
  document.querySelectorAll("#partyListTable tbody tr").forEach(row=>{
    const [partyCell,factionCell]=row.querySelectorAll("input");
    const party=partyCell.value.trim(), faction=factionCell.value.trim();
    if(party && faction){
      const votes=parseInt(document.querySelector(`#houseBody tr td input[value='${party}']`)?.value)||0;
    }
  });

  // --- Senate allocation ---
  let councilSeats={}, seatAssignments=[], assignedSeats=0, vacantSeats=0, occupiedSeats=0;
  let occupiedByParty={}, vacantByParty={};

  partyOrder.forEach(p=>{ if(validParties[p]){ councilSeats[p]=0; occupiedByParty[p]=0; vacantByParty[p]=0; } });

  function getNextCandidate(party,faction=null){
    if(faction){ return factionLists[party][faction].shift()||null; }
    return partyLists[party]&&partyLists[party].length?partyLists[party].shift():null;
  }

  while(vacantSeats<requiredVacantSeats && assignedSeats<maxSeats){
    const quotients={};
    for(let p in councilSeats){ quotients[p]=houseResults[p]/(councilSeats[p]+1); }
    const nextParty=Object.keys(quotients).reduce((a,b)=>quotients[a]>quotients[b]?a:b);
    assignedSeats++; councilSeats[nextParty]++;

    // Sub-allocate within party to factions
    let faction=null;
    if(factionLists[nextParty]){
      const subQuotients={}; 
      const totalPartyVotes=houseResults[nextParty]+Object.values(factionVotes[nextParty]||{}).reduce((a,b)=>a+b,0);
      subQuotients[nextParty]=houseResults[nextParty]/((partyLists[nextParty]?.length||0)+1);
      Object.keys(factionLists[nextParty]).forEach(f=>{
        subQuotients[f]= (factionVotes[nextParty][f]||0)/((factionLists[nextParty][f].length||0)+1);
      });
      faction=Object.keys(subQuotients).reduce((a,b)=>subQuotients[a]>subQuotients[b]?a:b);
      if(faction===nextParty) faction=null;
    }

    const candidate=getNextCandidate(nextParty,faction);
    if(candidate){
      seatAssignments.push([assignedSeats, nextParty+(faction?` (${faction})`:''), candidate]);
      occupiedSeats++; occupiedByParty[nextParty]++;
    } else {
      seatAssignments.push([assignedSeats, nextParty+(faction?` (${faction})`:''), "VACANT"]);
      vacantSeats++; vacantByParty[nextParty]++;
    }
  }

  // --- Results text ---
  let output="National Council Seat Assignments:\n";
  seatAssignments.forEach(([num,party,member])=>{
    output+=`Seat ${num}: ${party} → ${member}\n`;
  });
  output+="\nSeat Totals:\n"; for(let p in councilSeats) output+=`${p}: ${councilSeats[p]}\n`;
  output+="\nOccupied Seats by Party:\n"; for(let p in occupiedByParty) output+=`${p}: ${occupiedByParty[p]}\n`;
  output+="\nVacant Seats by Party:\n"; for(let p in vacantByParty) output+=`${p}: ${vacantByParty[p]}\n`;
  output+=`\nTotal Occupied: ${occupiedSeats}\nTotal Vacant: ${vacantSeats}\nTotal Assigned: ${assignedSeats}\n`;
  document.getElementById("results").textContent=output;
}

// --- Download/export ---
function downloadSeatImage(){const c=document.getElementById('seatCanvas');const l=document.createElement('a');l.href=c.toDataURL('image/png');l.download='seat_grid.png';l.click();}
function downloadSortedSeatImage(){const c=document.getElementById('seatCanvasSorted');const l=document.createElement('a');l.href=c.toDataURL('image/png');l.download='sorted_seat_grid.png';l.click();}
function exportCSV(){const t=document.getElementById('results').textContent.replace(/\n/g,'\r\n');const b=new Blob([t],{type:'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='results.txt';a.click();}
</script>
</body>
</html>
