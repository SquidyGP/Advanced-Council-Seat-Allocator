<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator (with Factions)</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f7f9fc; color: #333; }
h1, h2 { color: #222; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: #fff; }
th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
input { width: 100%; padding: 0.4rem; box-sizing: border-box; }
button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.2rem 0; cursor: pointer; border-radius: 6px; border: 1px solid #666; background: #eee; }
button:hover { background: #ddd; }
.add-row { margin-bottom: 1rem; }
pre { background: #fff; padding: 1rem; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
canvas { margin: 1rem 0; max-width: 600px; }
.legend { margin: 1rem 0; padding: 0.5rem; border-radius: 6px; background: #333; color: white; }
.legend div { margin: 0.2rem 0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>National Council Seat Allocator (with Factions)</h1>

<h2>Party List Results</h2>
<table id="houseTable">
    <thead>
        <tr><th>Party Name</th><th>Votes</th><th>Party Color</th><th>Action</th></tr>
    </thead>
    <tbody id="houseBody">
        <tr><td><input value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    </tbody>
</table>
<button class="add-row" onclick="addHouseRow()">+ Add Party</button>

<h2>Party Lists (Candidates)</h2>
<table id="partyListTable">
    <thead>
        <tr><th>Party Name</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr>
    </thead>
    <tbody id="partyListBody">
        <tr><td><input value="Reclaim"></td><td><input value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Purple Crown"></td><td><input value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Social Democratic"></td><td><input value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi- ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Solarist"></td><td><input value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
        <tr><td><input value="Progressive"></td><td><input value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    </tbody>
</table>
<button class="add-row" onclick="addPartyListRow()">+ Add Party</button>

<h2>Factions</h2>
<table id="factionTable">
    <thead>
        <tr><th>Parent Party</th><th>Faction Name</th><th>Votes</th><th>Candidate Names (comma-separated)</th><th>Action</th></tr>
    </thead>
    <tbody id="factionBody">
        <tr><td><input value="Social Democratic"></td><td><input value="Communist"></td><td><input type="number" value="0"></td><td><input value=""></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    </tbody>
</table>
<button class="add-row" onclick="addFactionRow()">+ Add Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats:</label>
<input type="number" id="requiredVacant" value="5" min="0">
<br><br>
<label>Maximum Total Seats:</label>
<input type="number" id="maxSeats" value="150" min="1">
<br><br>
<label>Threshold (% of votes required):</label>
<input type="number" id="threshold" value="5" min="0" max="100">
<br><br>
<button onclick="allocateSeats()">Allocate Seats</button>
<button onclick="exportCSV()">Export CSV</button>

<h2>Results</h2>
<pre id="results"></pre>

<h2>Visualizations</h2>
<canvas id="vacantChart"></canvas>
<div id="legend" class="legend"></div>

<script>
// --- Table Helpers ---
function deleteRow(button) { button.closest('tr').remove(); }
function addHouseRow() {
    const tbody = document.getElementById("houseBody");
    const row = document.createElement("tr");
    row.innerHTML = `<td><input></td><td><input type="number"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
    tbody.appendChild(row);
}
function addPartyListRow() {
    const tbody = document.getElementById("partyListBody");
    const row = document.createElement("tr");
    row.innerHTML = `<td><input></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
    tbody.appendChild(row);
}
function addFactionRow() {
    const tbody = document.getElementById("factionBody");
    const row = document.createElement("tr");
    row.innerHTML = `<td><input></td><td><input></td><td><input type="number"></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
    tbody.appendChild(row);
}

// --- Allocation Logic (fixed factions) ---
let vacantChart;

function allocateSeats() {
    const houseResults = {}, partyColors = {}, partyOrder = [];
    let totalVotes = 0;

    // Party votes
    document.querySelectorAll("#houseTable tbody tr").forEach(row => {
        const [partyCell, votesCell, colorCell] = row.querySelectorAll("input");
        const party = partyCell.value.trim();
        const votes = parseInt(votesCell.value) || 0;
        const color = colorCell.value || "#888888";
        if (party) {
            houseResults[party] = votes;
            partyColors[party] = color;
            partyOrder.push(party);
            totalVotes += votes;
        }
    });

    // Party lists
    const partyLists = {};
    document.querySelectorAll("#partyListTable tbody tr").forEach(row => {
        const [partyCell, candidatesCell] = row.querySelectorAll("input");
        const party = partyCell.value.trim();
        if (party) {
            partyLists[party] = candidatesCell.value.split(",").map(s => s.trim()).filter(Boolean);
        }
    });

    // Factions
    const factionVotes = {}, factionLists = {};
    document.querySelectorAll("#factionTable tbody tr").forEach(row => {
        const [partyCell, factionCell, votesCell, candidatesCell] = row.querySelectorAll("input");
        const party = partyCell.value.trim();
        const faction = factionCell.value.trim();
        const votes = parseInt(votesCell.value) || 0;
        if (party && faction) {
            if (!factionVotes[party]) factionVotes[party] = {};
            if (!factionLists[party]) factionLists[party] = {};
            factionVotes[party][faction] = votes;
            factionLists[party][faction] = candidatesCell.value.split(",").map(s => s.trim()).filter(Boolean);
            totalVotes += votes;
        }
    });

    const threshold = parseFloat(document.getElementById("threshold").value) || 0;
    const requiredVacantSeats = parseInt(document.getElementById("requiredVacant").value);
    const maxSeats = parseInt(document.getElementById("maxSeats").value);

    // Step 1: Parties that pass threshold
    const councilSeats = {}, occupiedByParty = {}, vacantByParty = {}, validParties = [];
    for (let party of partyOrder) {
        const totalPartyVotes = (houseResults[party] || 0) +
            (factionVotes[party] ? Object.values(factionVotes[party]).reduce((a,b)=>a+b,0) : 0);
        if (totalVotes > 0 && (totalPartyVotes / totalVotes * 100) >= threshold) {
            validParties.push(party);
            councilSeats[party] = 0;
            occupiedByParty[party] = 0;
            vacantByParty[party] = 0;
        }
    }

    // Step 2: External D’Hondt
    let assignedSeats = 0, vacantSeats = 0, occupiedSeats = 0, seatAssignments = [];
    while (vacantSeats < requiredVacantSeats && assignedSeats < maxSeats) {
        const quotients = {};
        for (let party of validParties) {
            const totalPartyVotes = (houseResults[party] || 0) +
                (factionVotes[party] ? Object.values(factionVotes[party]).reduce((a,b)=>a+b,0) : 0);
            quotients[party] = totalPartyVotes / (councilSeats[party] + 1);
        }
        const nextParty = Object.keys(quotients).reduce((a,b)=>quotients[a]>quotients[b]?a:b);
        councilSeats[nextParty]++;
        assignedSeats++;
    }

    // Step 3: Internal faction distribution
    function getNextCandidate(list) { return list && list.length ? list.shift() : null; }
    for (let party of validParties) {
        const partyTotalVotes = (houseResults[party] || 0) +
            (factionVotes[party] ? Object.values(factionVotes[party]).reduce((a,b)=>a+b,0) : 0);

        const internalVotes = {};
        if (houseResults[party]) internalVotes["Main"] = houseResults[party];
        if (factionVotes[party]) {
            for (let f in factionVotes[party]) internalVotes[f] = factionVotes[party][f];
        }

        let internalSeats = {};
        for (let k in internalVotes) internalSeats[k] = 0;
        for (let s = 0; s < councilSeats[party]; s++) {
            const q = {};
            for (let k in internalVotes) q[k] = internalVotes[k] / (internalSeats[k] + 1);
            const next = Object.keys(q).reduce((a,b)=>q[a]>q[b]?a:b);
            internalSeats[next]++;
        }

        for (let key in internalSeats) {
            let list = key === "Main" ? (partyLists[party] || []) : (factionLists[party][key] || []);
            for (let i = 0; i < internalSeats[key]; i++) {
                const candidate = getNextCandidate(list);
                const seatNum = seatAssignments.length + 1;
                if (candidate) {
                    seatAssignments.push([seatNum, party, candidate, key]);
                    occupiedSeats++; occupiedByParty[party]++;
                } else {
                    seatAssignments.push([seatNum, party, "VACANT", key]);
                    vacantSeats++; vacantByParty[party]++;
                }
            }
        }
    }

    // Step 4: Next in line
    let nextInLineParty = "N/A";
    if (assignedSeats < maxSeats) {
        const nextQuotients = {};
        for (let party of validParties) {
            const totalPartyVotes = (houseResults[party] || 0) +
                (factionVotes[party] ? Object.values(factionVotes[party]).reduce((a,b)=>a+b,0) : 0);
            nextQuotients[party] = totalPartyVotes / (councilSeats[party] + 1);
        }
        nextInLineParty = Object.keys(nextQuotients).reduce((a,b)=>nextQuotients[a]>nextQuotients[b]?a:b);
    }

    // Output
    let output = "National Council Seat Assignments:\n";
    seatAssignments.forEach(([num, party, member, key]) => {
        output += `Seat ${num}: ${party} (${key}) → ${member}\n`;
    });
    output += "\nSeat Totals (including vacant seats):\n";
    for (let party in councilSeats) output += `${party}: ${councilSeats[party]}\n`;
    output += "\nOccupied Seats by Party:\n";
    for (let party in occupiedByParty) output += `${party}: ${occupiedByParty[party]}\n`;
    output += "\nVacant Seats by Party:\n";
    for (let party in vacantByParty) output += `${party}: ${vacantByParty[party]}\n`;
    output += `\nTotal Occupied Seats: ${occupiedSeats}\nTotal Vacant Seats: ${vacantSeats}\nTotal Seats Assigned: ${assignedSeats}\n`;
    output += `\n📌 Next Party in Line for a Seat: ${nextInLineParty}`;
    document.getElementById("results").textContent = output;

    // Chart: Vacant vs Occupied
    const labels = Object.keys(councilSeats);
    const occupiedData = labels.map(p=>occupiedByParty[p]||0);
    const vacantData = labels.map(p=>vacantByParty[p]||0);
    if (vacantChart) vacantChart.destroy();
    vacantChart = new Chart(document.getElementById("vacantChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label:"Occupied", data: occupiedData, backgroundColor:"#4caf50" },
                { label:"Vacant", data: vacantData, backgroundColor:"#f44336" }
            ]
        },
        options: { responsive:true, plugins:{legend:{position:'top'}}, scales:{x:{stacked:true}, y:{stacked:true}} }
    });

    // Legend
    const legend = document.getElementById("legend");
    legend.innerHTML = "";
    for (let party in partyColors) {
        const div = document.createElement("div");
        div.innerHTML = `<span style="background:${partyColors[party]}; display:inline-block; width:16px; height:16px; margin-right:6px;"></span> ${party}`;
        legend.appendChild(div);
    }
}

// Export CSV
function exportCSV() {
    const text = document.getElementById("results").textContent;
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "allocation_results.csv"; a.click();
}
</script>
</body>
</html>
