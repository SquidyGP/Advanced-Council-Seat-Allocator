<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator with Factions</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

.container {
  background-color: white;
  border-radius: 8px;
  padding: 30px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

h1 {
  color: #2d3748;
  font-size: 2.5em;
  margin-bottom: 10px;
  text-align: center;
}

h2 {
  color: #4a5568;
  font-size: 1.8em;
  margin-top: 30px;
  margin-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
  padding-bottom: 10px;
}

h3 {
  color: #2d3748;
  font-size: 1.3em;
  margin: 15px 0;
}

h4 {
  color: #4a5568;
  font-size: 1.1em;
  margin: 10px 0;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-bottom: 20px;
  background-color: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  overflow: hidden;
}

table, th, td {
  border: 1px solid #e2e8f0;
}

th, td {
  padding: 12px;
  text-align: left;
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

tr:nth-child(even) {
  background-color: #f7fafc;
}

tr:hover {
  background-color: #edf2f7;
}

input[type="text"], input[type="number"] {
  padding: 8px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s;
}

input[type="text"]:focus, input[type="number"]:focus {
  outline: none;
  border-color: #667eea;
}

input[type="color"] {
  padding: 2px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  cursor: pointer;
  width: 50px;
  height: 35px;
}

button {
  padding: 10px 20px;
  margin: 5px;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

button.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

button.secondary {
  background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
  color: white;
}

button.delete {
  background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  color: white;
  font-size: 12px;
  padding: 6px 12px;
}

button:active {
  transform: translateY(0);
}

canvas {
  border: 2px solid #e2e8f0;
  margin-top: 15px;
  display: block;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

pre {
  background-color: #f7fafc;
  padding: 20px;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
  overflow-x: auto;
  font-family: 'Courier New', monospace;
  line-height: 1.6;
  font-size: 14px;
}

.controls {
  margin: 25px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

label {
  display: inline-block;
  margin: 10px 15px 10px 0;
  font-weight: 500;
  color: #4a5568;
}

label input {
  margin-left: 8px;
}

.party-container {
  border: 2px solid #e2e8f0;
  padding: 20px;
  margin-bottom: 25px;
  border-radius: 8px;
  background: linear-gradient(to right, #ffffff 0%, #f7fafc 100%);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: box-shadow 0.3s;
}

.party-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.party-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.party-name {
  flex: 1;
  min-width: 200px;
  font-size: 16px;
  font-weight: bold;
}

.party-total {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 15px;
  font-size: 18px;
  padding: 10px 15px;
  background-color: #edf2f7;
  border-radius: 6px;
  display: inline-block;
}

.party-votes {
  color: #667eea;
  font-size: 20px;
}

.faction-section {
  margin-top: 15px;
}

.faction-candidates {
  margin-bottom: 20px;
  padding: 15px;
  border-left: 4px solid #667eea;
  background-color: #f7fafc;
  border-radius: 6px;
  transition: background-color 0.3s;
}

.faction-candidates:hover {
  background-color: #edf2f7;
}

.faction-candidates h4 {
  margin-top: 0;
  color: #667eea;
}

.faction-candidate-names {
  width: 100%;
  padding: 10px;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">

<h1>üèõÔ∏è National Council Seat Allocator</h1>

<h2>Parties and Factions</h2>
<div id="partiesContainer">
  <!-- Party template -->
  <div class="party-container" data-party-index="0">
    <div class="party-header">
      <input type="text" class="party-name" value="Reclaim" placeholder="Party Name">
      <input type="color" class="party-color" value="#00ffff">
      <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
      <button onclick="deleteParty(this)" class="delete">Delete Party</button>
    </div>
    <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
    <div class="faction-section">
      <table class="faction-table">
        <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
        <tbody>
          <tr data-faction-id="faction-init-0"><td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('faction-init-0', this.value)"></td><td><input type="number" class="faction-votes" value="6" min="0" onchange="updatePartyTotal(this)"></td><td><button onclick="showFactionCandidates('faction-init-0')">Edit Candidates</button><button onclick="deleteFaction(this)">Delete</button></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="party-container" data-party-index="1">
    <div class="party-header">
      <input type="text" class="party-name" value="Purple Crown" placeholder="Party Name">
      <input type="color" class="party-color" value="#800080">
      <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
      <button onclick="deleteParty(this)" class="delete">Delete Party</button>
    </div>
    <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
    <div class="faction-section">
      <table class="faction-table">
        <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
        <tbody>
          <tr data-faction-id="faction-init-1"><td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('faction-init-1', this.value)"></td><td><input type="number" class="faction-votes" value="11" min="0" onchange="updatePartyTotal(this)"></td><td><button onclick="showFactionCandidates('faction-init-1')">Edit Candidates</button><button onclick="deleteFaction(this)">Delete</button></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="party-container" data-party-index="2">
    <div class="party-header">
      <input type="text" class="party-name" value="Social Democratic" placeholder="Party Name">
      <input type="color" class="party-color" value="#ff0000">
      <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
      <button onclick="deleteParty(this)" class="delete">Delete Party</button>
    </div>
    <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
    <div class="faction-section">
      <table class="faction-table">
        <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
        <tbody>
          <tr data-faction-id="faction-init-2"><td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('faction-init-2', this.value)"></td><td><input type="number" class="faction-votes" value="3" min="0" onchange="updatePartyTotal(this)"></td><td><button onclick="showFactionCandidates('faction-init-2')">Edit Candidates</button><button onclick="deleteFaction(this)">Delete</button></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="party-container" data-party-index="3">
    <div class="party-header">
      <input type="text" class="party-name" value="Solarist" placeholder="Party Name">
      <input type="color" class="party-color" value="#ffff00">
      <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
      <button onclick="deleteParty(this)" class="delete">Delete Party</button>
    </div>
    <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
    <div class="faction-section">
      <table class="faction-table">
        <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
        <tbody>
          <tr data-faction-id="faction-init-3"><td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('faction-init-3', this.value)"></td><td><input type="number" class="faction-votes" value="8" min="0" onchange="updatePartyTotal(this)"></td><td><button onclick="showFactionCandidates('faction-init-3')">Edit Candidates</button><button onclick="deleteFaction(this)">Delete</button></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="party-container" data-party-index="4">
    <div class="party-header">
      <input type="text" class="party-name" value="Progressive" placeholder="Party Name">
      <input type="color" class="party-color" value="#00ff00">
      <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
      <button onclick="deleteParty(this)" class="delete">Delete Party</button>
    </div>
    <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
    <div class="faction-section">
      <table class="faction-table">
        <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
        <tbody>
          <tr data-faction-id="faction-init-4"><td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('faction-init-4', this.value)"></td><td><input type="number" class="faction-votes" value="2" min="0" onchange="updatePartyTotal(this)"></td><td><button onclick="showFactionCandidates('faction-init-4')">Edit Candidates</button><button onclick="deleteFaction(this)">Delete</button></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<button onclick="addParty()" class="primary">+ Add Party</button>

<h2>Faction Candidates</h2>
<div id="factionsCandidatesContainer" style="margin-top: 20px;">
    <div class="faction-candidates" data-faction-id="faction-init-0">
        <h4>Main Faction Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="faction-init-0" 
                   style="width: 100%; padding: 5px;"
                   value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico">
        </div>
    </div>
    
    <div class="faction-candidates" data-faction-id="faction-init-1">
        <h4>Main Faction Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="faction-init-1" 
                   style="width: 100%; padding: 5px;"
                   value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski">
        </div>
    </div>
    
    <div class="faction-candidates" data-faction-id="faction-init-2">
        <h4>Main Faction Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="faction-init-2" 
                   style="width: 100%; padding: 5px;"
                   value="Dubovy Sedliak, Jakub Mazar, Filip Koz√°khvi-ezdoslavi√ß, Staunch, Sigmaiusasin">
        </div>
    </div>
    
    <div class="faction-candidates" data-faction-id="faction-init-3">
        <h4>Main Faction Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="faction-init-3" 
                   style="width: 100%; padding: 5px;"
                   value="Hiro Solarist, Circa">
        </div>
    </div>
    
    <div class="faction-candidates" data-faction-id="faction-init-4">
        <h4>Main Faction Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="faction-init-4" 
                   style="width: 100%; padding: 5px;"
                   value="Michael Brain">
        </div>
    </div>
</div>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5" min="0"></label><br>
<label>Maximum Total Seats: <input type="number" id="maxSeats" value="150" min="1"></label><br>
<label>Threshold (% votes required): <input type="number" id="threshold" value="5" min="0" max="100"></label><br>
<label><input type="checkbox" id="showFactions" checked> Show Faction Details in Results</label><br>

<div class="controls">
  <button class="primary" onclick="allocateSeats()">Allocate Seats</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="downloadSeatImage()">Download Seat Grid Image</button>
  <button onclick="downloadSortedSeatImage()">Download Sorted Seat Grid Image</button>
</div>

<h2>Results</h2>
<pre id="results">Run allocation to see results here.</pre>

<h2>Original Seat Grid</h2>
<canvas id="seatCanvas"></canvas>

<h2>Sorted Seat Grid (Largest Party ‚Üí Smallest, Vacants Last)</h2>
<canvas id="seatCanvasSorted"></canvas>

</div>
<script>
// --- Party and Faction Management ---
let partyCounter = 5; // Start after the initial 5 parties

// Add a new party
function addParty() {
    const partyIndex = partyCounter++;
    const partyDiv = document.createElement('div');
    partyDiv.className = 'party-container';
    partyDiv.dataset.partyIndex = partyIndex;
    
    // Generate a random color
    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
    const initialFactionId = 'faction-' + Date.now();
    
    partyDiv.innerHTML = `
        <div class="party-header">
            <input type="text" class="party-name" placeholder="Party Name">
            <input type="color" class="party-color" value="${randomColor}">
            <button onclick="addFaction(this)" class="secondary">+ Add Faction</button>
            <button onclick="deleteParty(this)" class="delete">Delete Party</button>
        </div>
        <div class="party-total">Total Votes: <span class="party-votes">0</span></div>
        <div class="faction-section">
            <table class="faction-table">
                <thead><tr><th>Faction Name</th><th>Votes</th><th>Actions</th></tr></thead>
                <tbody>
                    <tr data-faction-id="${initialFactionId}">
                        <td><input type="text" class="faction-name" value="Main Faction" onchange="updateFactionName('${initialFactionId}', this.value)"></td>
                        <td><input type="number" class="faction-votes" value="0" min="0" onchange="updatePartyTotal(this)"></td>
                        <td>
                            <button onclick="showFactionCandidates('${initialFactionId}')">Edit Candidates</button>
                            <button onclick="deleteFaction(this)">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('partiesContainer').appendChild(partyDiv);
    
    // Add candidate list for the main faction
    addFactionCandidateList(partyIndex, initialFactionId, 'Main Faction');
}

// Add a new faction to a party
function addFaction(button) {
    const partyContainer = button.closest('.party-container');
    const partyIndex = partyContainer.dataset.partyIndex;
    const tbody = partyContainer.querySelector('.faction-table tbody');
    const factionId = 'faction-' + Date.now(); // Unique ID for the faction
    
    const newRow = document.createElement('tr');
    newRow.dataset.factionId = factionId;
    newRow.innerHTML = `
        <td>
            <input type="text" class="faction-name" value="New Faction" 
                   onchange="updateFactionName('${factionId}', this.value)">
        </td>
        <td><input type="number" class="faction-votes" value="0" min="0" onchange="updatePartyTotal(this)"></td>
        <td>
            <button onclick="showFactionCandidates('${factionId}')">Edit Candidates</button>
            <button onclick="deleteFaction(this)">Delete</button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    updatePartyTotal(button);
    
    // Add a new candidate list for this faction
    addFactionCandidateList(partyIndex, factionId);
    
    return factionId;
}

// Update faction name in the corresponding candidate list
function updateFactionName(factionId, newName) {
    const candidateHeader = document.querySelector(`.faction-candidates[data-faction-id="${factionId}"] h4`);
    if (candidateHeader) {
        candidateHeader.textContent = (newName || 'Unnamed Faction') + ' Candidates';
    }
    
    // Also update the data attribute if it exists as a class
    const factionInput = document.querySelector(`.faction-name[data-faction-id="${factionId}"]`);
    if (factionInput) {
        factionInput.setAttribute('data-faction-name', newName || 'Unnamed Faction');
    }
}

// Show/hide faction candidates
function showFactionCandidates(factionId) {
    const candidateDiv = document.querySelector(`.faction-candidates[data-faction-id="${factionId}"]`);
    if (candidateDiv) {
        // Scroll to the candidate list
        candidateDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Highlight the candidate list briefly
        candidateDiv.style.backgroundColor = '#f8f9fa';
        setTimeout(() => {
            candidateDiv.style.backgroundColor = '';
        }, 1000);
    }
}

// Delete a faction and its candidate list
function deleteFaction(button) {
    const row = button.closest('tr');
    if (row && confirm('Are you sure you want to delete this faction and its candidates?')) {
        const factionId = row.dataset.factionId;
        
        // Remove the faction row
        row.remove();
        
        // Remove the faction's candidate list
        const candidateDiv = document.querySelector(`.faction-candidates[data-faction-id="${factionId}"]`);
        if (candidateDiv) {
            candidateDiv.remove();
        }
        
        // Update party total
        updatePartyTotal(button);
    }
}



// Delete a party
function deleteParty(button) {
    if (confirm('Are you sure you want to delete this party and all its factions?')) {
        const partyContainer = button.closest('.party-container');
        const partyIndex = partyContainer.dataset.partyIndex;
        
        // Remove the party container
        partyContainer.remove();
        
        // Remove the corresponding candidate list
        const candidateList = document.querySelector(`.candidate-list[data-party-index="${partyIndex}"]`);
        if (candidateList) {
            candidateList.remove();
        }
    }
}

// Update the party's total votes
function updatePartyTotal(input) {
    const partyContainer = input.closest('.party-container');
    const factionInputs = partyContainer.querySelectorAll('.faction-votes');
    let total = 0;
    
    factionInputs.forEach(input => {
        total += parseInt(input.value) || 0;
    });
    
    const totalSpan = partyContainer.querySelector('.party-votes');
    if (totalSpan) {
        totalSpan.textContent = total;
    }
}

// Add a candidate list for a faction
function addFactionCandidateList(partyIndex, factionId, factionName = 'New Faction') {
    const factionsContainer = document.getElementById('factionsCandidatesContainer');
    
    const factionCandidatesDiv = document.createElement('div');
    factionCandidatesDiv.className = 'faction-candidates';
    factionCandidatesDiv.dataset.factionId = factionId;
    factionCandidatesDiv.style.marginBottom = '15px';
    factionCandidatesDiv.style.padding = '10px';
    factionCandidatesDiv.style.borderLeft = '2px solid #ccc';
    
    factionCandidatesDiv.innerHTML = `
        <h4>${factionName} Candidates</h4>
        <div style="margin-left: 15px;">
            <input type="text" class="faction-candidate-names" 
                   placeholder="Candidate 1, Candidate 2, ..." 
                   data-faction-id="${factionId}" 
                   style="width: 100%; padding: 5px;">
        </div>
    `;
    
    factionsContainer.appendChild(factionCandidatesDiv);
    
    // Link the faction name to the candidate list
    const factionNameInput = document.querySelector(`.faction-name[data-faction-id="${factionId}"], 
                                                  [onchange*="${factionId}"]`);
    if (factionNameInput) {
        factionNameInput.addEventListener('input', function() {
            const header = factionCandidatesDiv.querySelector('h4');
            if (header) {
                header.textContent = (this.value || 'Unnamed Faction') + ' Candidates';
            }
        });
    }
    
    return factionCandidatesDiv;
}

// --- Global data ---
let seatAssignmentsGlobal=[], councilSeatsGlobal={}, partyColorsGlobal={}, councilPartiesGlobal=[], occupiedByPartyGlobal={}, vacantByPartyGlobal={}, nextPartyGlobal='';

// --- Allocation ---
function allocateSeats() {
    const partyData = {};
    const partyColors = {};
    const partyOrder = [];
    const partyCandidates = {};
    let totalVotes = 0;
    const showFactions = document.getElementById('showFactions').checked;
    
    // Collect party and faction data
    document.querySelectorAll('.party-container').forEach(partyContainer => {
        const partyName = partyContainer.querySelector('.party-name').value.trim();
        const partyColor = partyContainer.querySelector('.party-color').value || '#888888';
        
        if (!partyName) return; // Skip parties with no name
        
        // Get all factions for this party
        const factions = [];
        let partyVotes = 0;
        
        partyContainer.querySelectorAll('.faction-table tbody tr').forEach(row => {
            const nameInput = row.querySelector('.faction-name');
            const votesInput = row.querySelector('.faction-votes');
            
            if (nameInput && votesInput) {
                const factionName = nameInput.value.trim() || 'Unnamed Faction';
                const factionVotes = parseInt(votesInput.value) || 0;
                
                if (factionName) {
                    factions.push({
                        id: row.dataset.factionId || `faction-${Date.now()}-${i}`,
                        name: factionName,
                        votes: factionVotes
                    });
                    partyVotes += factionVotes;
                }
            }
        });
        
        // Store party data
        partyData[partyName] = {
            votes: partyVotes,
            factions: factions,
            color: partyColor
        };
        
        partyColors[partyName] = partyColor;
        partyOrder.push(partyName);
        totalVotes += partyVotes;
    });
    
    // Get allocation parameters
    const threshold = parseFloat(document.getElementById('threshold').value) || 0;
    const requiredVacantSeats = parseInt(document.getElementById('requiredVacant').value) || 0;
    const maxSeats = parseInt(document.getElementById('maxSeats').value) || 1000;
    
    // Calculate which parties meet the threshold
    const councilParties = [];
    const councilSeats = {};
    
    for (const party of partyOrder) {
        const partyVotes = partyData[party].votes;
        if (totalVotes > 0 && (partyVotes / totalVotes * 100) < threshold) continue;
        
        councilParties.push(party);
        councilSeats[party] = 0;
    }
    
    if (councilParties.length === 0) {
        document.getElementById('results').textContent = 'No parties meet the threshold.';
        drawSeatGrid([], 0, 'seatCanvas');
        drawSeatGrid([], 0, 'seatCanvasSorted');
        return;
    }
    
    // Allocate seats to parties using the D'Hondt method
    const seatAssignments = [];
    const factionSeatAssignments = [];
    let assignedSeats = 0;
    
    // Allocate seats to parties
    for (let i = 0; i < maxSeats; i++) {
        let maxQ = -1;
        let nextParty = councilParties[0];
        
        // Find the party with the highest quotient
        for (const party of councilParties) {
            const q = (partyData[party].votes || 0) / (councilSeats[party] + 1);
            if (q > maxQ) {
                maxQ = q;
                nextParty = party;
            }
        }
        
        councilSeats[nextParty]++;
        assignedSeats++;
    }
    
    // Allocate seats to factions within each party
    if (showFactions) {
        for (const party of councilParties) {
            const partySeats = councilSeats[party];
            if (partySeats === 0) continue;
            
            const partyInfo = partyData[party];
            const factions = partyInfo.factions || [];
            
            if (factions.length === 0) continue;
            
            // Calculate total votes for all factions in this party
            const totalFactionVotes = factions.reduce((sum, f) => sum + (f.votes || 0), 0);
            if (totalFactionVotes === 0) continue;
            
            // Allocate seats to factions using the same method as for parties
            const factionSeats = {};
            const factionCandidates = {};
            
            // Initialize faction data with their candidate lists
            for (const faction of factions) {
                factionSeats[faction.name] = 0;
                
                // Get candidates for this faction from the UI by faction ID
                const factionCandidateInput = document.querySelector(`.faction-candidate-names[data-faction-id="${faction.id}"]`);
                
                if (factionCandidateInput) {
                    factionCandidates[faction.name] = factionCandidateInput.value
                        .split(',')
                        .map(s => s.trim())
                        .filter(Boolean);
                } else {
                    factionCandidates[faction.name] = [];
                }
            }
            
            // Allocate this party's seats to its factions
            for (let i = 0; i < partySeats; i++) {
                let maxFactionQ = -1;
                let nextFaction = null;
                
                // Find the faction with the highest quotient
                for (const faction of factions) {
                    const q = (faction.votes || 0) / ((factionSeats[faction.name] || 0) + 1);
                    if (q > maxFactionQ) {
                        maxFactionQ = q;
                        nextFaction = faction;
                    }
                }
                
                if (nextFaction) {
                    const factionName = nextFaction.name;
                    factionSeats[factionName] = (factionSeats[factionName] || 0) + 1;
                    
                    // Get the next candidate from this faction's list
                    const candidates = factionCandidates[factionName] || [];
                    const candidate = candidates.length > 0 ? candidates.shift() : 'VACANT';
                    
                    factionSeatAssignments.push({
                        party: party,
                        faction: factionName,
                        candidate: candidate,
                        seatNumber: i + 1
                    });
                    
                    // Also add to main seat assignments
                    seatAssignments.push([assignedSeats - partySeats + i + 1, party, candidate]);
                }
            }
        }
    } else {
        // If not showing factions, just create generic seat assignments
        let seatNum = 1;
        for (const party of councilParties) {
            const partySeats = councilSeats[party];
            for (let i = 0; i < partySeats; i++) {
                seatAssignments.push([seatNum++, party, `Member ${i + 1}`]);
            }
        }
    }
    
    // Calculate next party in line
    let nextInLine = 'N/A';
    if (assignedSeats < maxSeats) {
        let maxQ = -1;
        for (const party of councilParties) {
            const q = (partyData[party].votes || 0) / (councilSeats[party] + 1);
            if (q > maxQ) {
                maxQ = q;
                nextInLine = party;
            }
        }
    }
    
    // Calculate vacant and occupied seats
    let vacantSeats = 0;
    let occupiedSeats = 0;
    const occupiedByParty = {};
    const vacantByParty = {};
    
    for (const party of councilParties) {
        occupiedByParty[party] = 0;
        vacantByParty[party] = 0;
    }
    
    seatAssignments.forEach(([num, party, member]) => {
        if (member === 'VACANT') {
            vacantSeats++;
            vacantByParty[party]++;
        } else {
            occupiedSeats++;
            occupiedByParty[party]++;
        }
    });
    
    // Update global state
    seatAssignmentsGlobal = seatAssignments;
    councilSeatsGlobal = councilSeats;
    partyColorsGlobal = partyColors;
    councilPartiesGlobal = councilParties;
    occupiedByPartyGlobal = occupiedByParty;
    vacantByPartyGlobal = vacantByParty;
    nextPartyGlobal = nextInLine;
    
    // Generate output
    let output = 'National Council Seat Assignments:\n';
    
    if (showFactions && factionSeatAssignments.length > 0) {
        // Group faction assignments by party
        const assignmentsByParty = {};
        for (const party of councilParties) {
            assignmentsByParty[party] = [];
        }
        
        factionSeatAssignments.forEach(assignment => {
            assignmentsByParty[assignment.party].push(assignment);
        });
        
        // Output faction assignments by party
        for (const party of councilParties) {
            if (assignmentsByParty[party].length > 0) {
                output += `\n${party} (${councilSeats[party]} seats):\n`;
                assignmentsByParty[party].forEach(({faction, candidate, seatNumber}) => {
                    output += `  ${faction} ‚Üí ${candidate}\n`;
                });
            }
        }
    } else {
        // Simple seat assignments without faction detail
        seatAssignments.forEach(([num, party, member]) => {
            output += `Seat ${num}: ${party} ‚Üí ${member}\n`;
        });
    }
    
    // Add party seat totals
    output += '\nSeat Totals:\n';
    for (const party of councilParties) {
        output += `${party}: ${councilSeats[party]}\n`;
    }
    
    // Add faction seat distribution if enabled
    if (showFactions && factionSeatAssignments.length > 0) {
        output += '\nFaction Seat Distribution:\n';
        for (const { party, faction, seats } of factionSeatAssignments) {
            output += `${party} - ${faction}: ${seats} seat${seats !== 1 ? 's' : ''}\n`;
        }
    }
    
    // Add occupied and vacant seats
    output += '\nOccupied Seats by Party:\n';
    for (const party of councilParties) {
        output += `${party}: ${occupiedByParty[party]}\n`;
    }
    
    output += '\nVacant Seats by Party:\n';
    for (const party of councilParties) {
        output += `${party}: ${vacantByParty[party]}\n`;
    }
    
    output += `\nTotal Seats Assigned: ${assignedSeats}\nüìå Next Party in Line: ${nextInLine}`;
    
    // Update the results display
    document.getElementById('results').textContent = output;
    
    // Draw seat grids
    drawSeatGrid(seatAssignments, assignedSeats, 'seatCanvas', true);
    drawSortedSeatGrid(seatAssignments, councilSeats, 'seatCanvasSorted', true);
}

// --- Seat grid functions ---
function drawSeatGrid(seats,totalSeats,canvasId, showLegend=false){
  const canvas=document.getElementById(canvasId); const ctx=canvas.getContext('2d');
  const seatSize=60; const padding=10; const seatsPerRow=Math.min(10,totalSeats); const rows=Math.ceil(totalSeats/seatsPerRow);
  canvas.width=seatsPerRow*(seatSize+padding)+padding; canvas.height=rows*(seatSize+padding)+150; ctx.clearRect(0,0,canvas.width,canvas.height);

  function wrapTextFit(context,text,x,y,maxWidth,maxHeight){
    let words=text.split(' '); let lines=[], line=''; for(let n=0;n<words.length;n++){const testLine=line+words[n]+' '; if(context.measureText(testLine).width>maxWidth && n>0){lines.push(line.trim()); line=words[n]+' ';} else line=testLine;} lines.push(line.trim());
    let fontSize=10; let lineHeight=fontSize*1.2; while(lineHeight*lines.length>maxHeight && fontSize>6){fontSize--; lineHeight=fontSize*1.2;}
    context.font=fontSize+'px Arial'; let startY=y-(lineHeight*(lines.length-1))/2; lines.forEach((l,i)=>context.fillText(l,x,startY+i*lineHeight));
  }

  seats.forEach((seat,i)=>{
    const row=Math.floor(i/seatsPerRow); const col=i%seatsPerRow;
    const x=padding+col*(seatSize+padding); const y=padding+row*(seatSize+padding);
    const partyColor=partyColorsGlobal[seat[1]]||'#888888'; const isVacant=seat[2]==='VACANT';
    ctx.fillStyle=isVacant?'#d3d3d3':partyColor; ctx.fillRect(x,y,seatSize,seatSize);
    ctx.strokeStyle=isVacant?partyColor:'#333'; ctx.lineWidth=2; ctx.strokeRect(x,y,seatSize,seatSize);
    ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.font='10px Arial'; ctx.textBaseline='top'; ctx.fillText('#'+seat[0],x+seatSize/2,y+2);
    ctx.textBaseline='middle'; wrapTextFit(ctx,isVacant?`${seat[1]} VACANT`:seat[2],x+seatSize/2,y+seatSize/2,seatSize-4,seatSize-18);
  });

  if(showLegend){
    let startX=padding; let startY=rows*(seatSize+padding)+20; ctx.textAlign='left'; ctx.font='12px Arial'; ctx.textBaseline='top';
    councilPartiesGlobal.forEach(p=>{
      ctx.fillStyle=partyColorsGlobal[p]; ctx.fillRect(startX,startY,15,15);
      ctx.fillStyle='white'; // legend text white
      ctx.fillText(`${p}: ${occupiedByPartyGlobal[p]} occupied, ${vacantByPartyGlobal[p]} vacant`,startX+20,startY);
      startY+=20;
    });
    ctx.fillStyle='white'; ctx.fillText(`Next Party in Line: ${nextPartyGlobal}`,startX,startY+5);
  }
}

// --- Sorted seat grid fix: tie-break by party name ---
function drawSortedSeatGrid(seats,councilSeats,canvasId,showLegend=false){
  const canvas=document.getElementById(canvasId); const ctx=canvas.getContext('2d');
  const seatSize=60; const padding=10; const totalSeats=seats.length; const seatsPerRow=Math.min(10,totalSeats); const rows=Math.ceil(totalSeats/seatsPerRow);
  canvas.width=seatsPerRow*(seatSize+padding)+padding; canvas.height=rows*(seatSize+padding)+150; ctx.clearRect(0,0,canvas.width,canvas.height);

  const occupiedSeats=seats.filter(s=>s[2]!=='VACANT'); const vacantSeats=seats.filter(s=>s[2]==='VACANT');
  const partyCounts={}; councilPartiesGlobal.forEach(p=>partyCounts[p]=councilSeats[p]||0);

  occupiedSeats.sort((a,b)=>{
    const diff = partyCounts[b[1]] - partyCounts[a[1]];
    if(diff !==0) return diff;
    return a[1].localeCompare(b[1]); // tie-break alphabetically
  });

  const sortedSeats=[...occupiedSeats,...vacantSeats];

  function wrapTextFit(context,text,x,y,maxWidth,maxHeight){
    let words=text.split(' '); let lines=[], line=''; for(let n=0;n<words.length;n++){const testLine=line+words[n]+' '; if(context.measureText(testLine).width>maxWidth && n>0){lines.push(line.trim()); line=words[n]+' ';} else line=testLine;} lines.push(line.trim());
    let fontSize=10; let lineHeight=fontSize*1.2; while(lineHeight*lines.length>maxHeight && fontSize>6){fontSize--; lineHeight=fontSize*1.2;}
    context.font=fontSize+'px Arial'; let startY=y-(lineHeight*(lines.length-1))/2; lines.forEach((l,i)=>context.fillText(l,x,startY+i*lineHeight));
  }

  sortedSeats.forEach((seat,i)=>{
    const row=Math.floor(i/seatsPerRow); const col=i%seatsPerRow;
    const x=padding+col*(seatSize+padding); const y=padding+row*(seatSize+padding);
    const partyColor=partyColorsGlobal[seat[1]]||'#888888'; const isVacant=seat[2]==='VACANT';
    ctx.fillStyle=isVacant?'#d3d3d3':partyColor; ctx.fillRect(x,y,seatSize,seatSize);
    ctx.strokeStyle=isVacant?partyColor:'#333'; ctx.lineWidth=2; ctx.strokeRect(x,y,seatSize,seatSize);
    ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.font='10px Arial'; ctx.textBaseline='top'; ctx.fillText('#'+seat[0],x+seatSize/2,y+2);
    ctx.textBaseline='middle'; wrapTextFit(ctx,isVacant?`${seat[1]} VACANT`:seat[2],x+seatSize/2,y+seatSize/2,seatSize-4,seatSize-18);
  });

  if(showLegend){
    let startX=padding; let startY=rows*(seatSize+padding)+20; ctx.textAlign='left'; ctx.font='12px Arial'; ctx.textBaseline='top';
    councilPartiesGlobal.forEach(p=>{
      ctx.fillStyle=partyColorsGlobal[p]; ctx.fillRect(startX,startY,15,15);
      ctx.fillStyle='white';
      ctx.fillText(`${p}: ${occupiedByPartyGlobal[p]} occupied, ${vacantByPartyGlobal[p]} vacant`,startX+20,startY);
      startY+=20;
    });
    ctx.fillStyle='white'; ctx.fillText(`Next Party in Line: ${nextPartyGlobal}`,startX,startY+5);
  }
}

// --- Download & export ---
function downloadSeatImage(){const canvas=document.getElementById('seatCanvas'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='seat_grid.png'; link.click();}
function downloadSortedSeatImage(){const canvas=document.getElementById('seatCanvasSorted'); const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='sorted_seat_grid.png'; link.click();}
function exportCSV(){const text=document.getElementById('results').textContent.replace(/\n/g,'\r\n'); const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='allocation_results.txt'; a.click();}
</script>

</body>
</html>
