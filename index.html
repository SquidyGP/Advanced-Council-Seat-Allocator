<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>National Council Seat Allocator (with Factions)</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f7f9fc; color: #333; }
h1, h2 { color: #222; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: #fff; }
th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
input { width: 100%; padding: 0.4rem; box-sizing: border-box; }
button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.2rem 0; cursor: pointer; border-radius: 6px; border: 1px solid #666; background: #eee; }
button:hover { background: #ddd; }
.add-row { margin-bottom: 1rem; }
pre { background: #fff; padding: 1rem; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
canvas { margin: 1rem 0; max-width: 600px; max-height: 400px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); gap: 5px; margin: 1rem 0; }
.seat { border: 1px solid #999; border-radius: 4px; padding: 2px; font-size: 11px; text-align: center; overflow: hidden; white-space: normal; word-wrap: break-word; background: #f0f0f0; }
.legend { margin-top: 1rem; font-size: 14px; }
.legend span { display: inline-block; margin-right: 10px; }
.legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>National Council Seat Allocator (with Factions)</h1>

<h2>Party List Results</h2>
<table id="partyTable">
  <thead>
    <tr><th>Party</th><th>Votes</th><th>Color</th><th>Action</th></tr>
  </thead>
  <tbody id="partyBody">
    <tr><td><input value="Reclaim"></td><td><input type="number" value="6"></td><td><input type="color" value="#00ffff"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input type="number" value="5"></td><td><input type="color" value="#800080"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input type="number" value="4"></td><td><input type="color" value="#ff0000"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input type="number" value="3"></td><td><input type="color" value="#ffff00"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input type="number" value="2"></td><td><input type="color" value="#ff69b4"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button onclick="addPartyRow()">+ Add Party</button>

<h2>Candidate Lists</h2>
<table id="candidateTable">
  <thead>
    <tr><th>Party</th><th>Faction (optional)</th><th>Votes</th><th>Candidates (comma-separated)</th><th>Action</th></tr>
  </thead>
  <tbody id="candidateBody">
    <tr><td><input value="Reclaim"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Josef, Bela Andrassy, Janek Komiga, John Louis Mormon, Robert Fico"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Purple Crown"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Cierna, Oldrich Vladislav, Schwarz, Katereinna Eliska Piotrowski"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Social Democratic"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Dubovy Sedliak, Jakub Mazar, Filip Kozákhvi-ezdoslaviç, Staunch, Sigmaiusasin"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Solarist"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Hiro Solarist, Circa"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
    <tr><td><input value="Progressive"></td><td><input></td><td><input type="number" value="0"></td><td><input value="Michael Brain"></td><td><button onclick="deleteRow(this)">Delete</button></td></tr>
  </tbody>
</table>
<button onclick="addCandidateRow()">+ Add Candidate/Faction</button>

<h2>Settings</h2>
<label>Required Vacant Seats: <input type="number" id="requiredVacant" value="5"></label><br>
<label>Maximum Seats: <input type="number" id="maxSeats" value="150"></label><br>
<label>Threshold (%): <input type="number" id="threshold" value="5"></label><br>
<button onclick="allocateSeats()">Allocate Seats</button>

<h2>Results</h2>
<pre id="results"></pre>

<h2>Seat Grids</h2>
<div>
  <h3>Original Order</h3>
  <div class="grid" id="seatGrid"></div>
</div>
<div>
  <h3>Sorted by Largest Party → Smallest (Vacants Last)</h3>
  <div class="grid" id="sortedSeatGrid"></div>
</div>
<div class="legend" id="legend"></div>

<script>
function deleteRow(btn){ btn.closest('tr').remove(); }
function addPartyRow(){
  const r=document.createElement('tr');
  r.innerHTML=`<td><input></td><td><input type="number"></td><td><input type="color" value="#888888"></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  document.getElementById('partyBody').appendChild(r);
}
function addCandidateRow(){
  const r=document.createElement('tr');
  r.innerHTML=`<td><input></td><td><input></td><td><input type="number"></td><td><input></td><td><button onclick="deleteRow(this)">Delete</button></td>`;
  document.getElementById('candidateBody').appendChild(r);
}

function allocateSeats(){
  const parties={}, colors={};
  let totalVotes=0;

  document.querySelectorAll('#partyBody tr').forEach(r=>{
    const [p,v,c]=r.querySelectorAll('input');
    if(p.value.trim()){
      parties[p.value.trim()]={votes:parseInt(v.value)||0, factions:{}, candidates:[], seats:0};
      colors[p.value.trim()]=c.value;
      totalVotes+=parseInt(v.value)||0;
    }
  });

  document.querySelectorAll('#candidateBody tr').forEach(r=>{
    const [p,f,v,c]=r.querySelectorAll('input');
    const party=p.value.trim();
    if(!party||!parties[party]) return;
    const faction=f.value.trim()||null;
    const votes=parseInt(v.value)||0;
    const candidates=c.value.split(',').map(x=>x.trim()).filter(Boolean);

    if(faction){
      parties[party].factions[faction]={votes,candidates,seats:0};
      totalVotes+=votes;
    } else {
      parties[party].candidates=candidates;
      parties[party].votes+=votes;
      totalVotes+=votes;
    }
  });

  const threshold=parseFloat(document.getElementById('threshold').value)||0;
  const requiredVacant=parseInt(document.getElementById('requiredVacant').value)||0;
  const maxSeats=parseInt(document.getElementById('maxSeats').value)||100;

  // external D'Hondt
  const councilParties={};
  for(let p in parties){
    let sumVotes=parties[p].votes;
    for(let f in parties[p].factions) sumVotes+=parties[p].factions[f].votes;
    if(totalVotes>0 && (sumVotes/totalVotes*100)>=threshold){
      councilParties[p]={votes:sumVotes,seats:0};
    }
  }

  let assigned=0,vacant=0;
  while(vacant<requiredVacant && assigned<maxSeats){
    let quotients={};
    for(let p in councilParties){
      quotients[p]=councilParties[p].votes/(councilParties[p].seats+1);
    }
    const nextParty=Object.keys(quotients).reduce((a,b)=>quotients[a]>quotients[b]?a:b);
    councilParties[nextParty].seats++;
    assigned++;
  }

  // internal allocation of each party's seats to factions + main list
  let seatAssignments=[];
  let seatNum=0;
  for(let p in councilParties){
    const totalPartyVotes=councilParties[p].votes;
    const totalSeats=councilParties[p].seats;

    // weights
    const allocations=[];
    const mainVotes=parties[p].votes;
    if(mainVotes>0||parties[p].candidates.length){ allocations.push({name:null,votes:mainVotes,candidates:parties[p].candidates}); }
    for(let f in parties[p].factions){ allocations.push({name:f,votes:parties[p].factions[f].votes,candidates:parties[p].factions[f].candidates}); }

    // distribute seats proportionally
    let frac=[];
    allocations.forEach((a,i)=>{ frac.push({idx:i,score:a.votes/totalPartyVotes,seats:0,rem:0}); });
    let allocated=0;
    allocations.forEach(f=>{ f.seats=Math.floor(f.score*totalSeats); allocated+=f.seats; f.rem=f.score*totalSeats-f.seats; });
    while(allocated<totalSeats){ frac.sort((a,b)=>b.rem-a.rem); frac[0].seats++; allocated++; frac[0].rem=0; }

    // assign candidates
    frac.forEach(f=>{
      const list=allocations[f.idx];
      for(let i=0;i<f.seats;i++){
        seatNum++;
        let cand=list.candidates.shift()||"VACANT";
        seatAssignments.push({num:seatNum,party:p,faction:list.name||"Main",candidate:cand});
      }
    });
  }

  // Output
  let out="National Council Seat Assignments:\n";
  seatAssignments.forEach(s=>{ out+=`Seat ${s.num}: ${s.party} (${s.faction}) → ${s.candidate}\n`; });
  document.getElementById('results').textContent=out;

  // seat grids
  const grid=document.getElementById('seatGrid');
  grid.innerHTML='';
  seatAssignments.forEach(s=>{
    const d=document.createElement('div');
    d.className='seat';
    d.style.background=colors[s.party];
    d.textContent=`${s.num}\n${s.candidate}`;
    grid.appendChild(d);
  });

  const sorted=document.getElementById('sortedSeatGrid');
  sorted.innerHTML='';
  let sortedSeats=[...seatAssignments].sort((a,b)=>{
    if(a.party!==b.party){
      return councilParties[b.party].seats-councilParties[a.party].seats;
    }
    if(a.candidate==="VACANT"&&b.candidate!=="VACANT") return 1;
    if(b.candidate==="VACANT"&&a.candidate!=="VACANT") return -1;
    return a.num-b.num;
  });
  sortedSeats.forEach(s=>{
    const d=document.createElement('div');
    d.className='seat';
    d.style.background=colors[s.party];
    d.textContent=`${s.num}\n${s.candidate}`;
    sorted.appendChild(d);
  });

  // legend
  let legendHTML="<b>Legend:</b> ";
  for(let p in colors){ legendHTML+=`<span><span class="legend-color" style="background:${colors[p]}"></span>${p}</span>`; }
  document.getElementById('legend').innerHTML=legendHTML;
}
</script>
</body>
</html>
